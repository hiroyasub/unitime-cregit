begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to The Apereo Foundation under one or more contributor license  * agreements. See the NOTICE file distributed with this work for  * additional information regarding copyright ownership.  *  * The Apereo Foundation licenses this file to you under the Apache License,  * Version 2.0 (the "License"); you may not use this file except in  * compliance with the License. You may obtain a copy of the License at:  *  * http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  *  * See the License for the specific language governing permissions and  * limitations under the License.  *  */
end_comment

begin_package
package|package
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|solver
operator|.
name|jgroups
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|OutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|lang
operator|.
name|reflect
operator|.
name|InvocationHandler
import|;
end_import

begin_import
import|import
name|java
operator|.
name|lang
operator|.
name|reflect
operator|.
name|Method
import|;
end_import

begin_import
import|import
name|java
operator|.
name|lang
operator|.
name|reflect
operator|.
name|Proxy
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Date
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Properties
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|logging
operator|.
name|log4j
operator|.
name|Level
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|logging
operator|.
name|log4j
operator|.
name|LogManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|logging
operator|.
name|log4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|logging
operator|.
name|log4j
operator|.
name|core
operator|.
name|LoggerContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|logging
operator|.
name|log4j
operator|.
name|core
operator|.
name|config
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|logging
operator|.
name|log4j
operator|.
name|core
operator|.
name|config
operator|.
name|Configurator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|cpsolver
operator|.
name|ifs
operator|.
name|util
operator|.
name|DataProperties
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|Address
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|JChannel
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|MembershipListener
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|MergeView
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|Message
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|MessageListener
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|Receiver
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|SuspectedException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|Message
operator|.
name|Flag
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|View
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|blocks
operator|.
name|RequestOptions
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|blocks
operator|.
name|ResponseMode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|blocks
operator|.
name|RpcDispatcher
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|blocks
operator|.
name|mux
operator|.
name|MuxRpcDispatcher
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|blocks
operator|.
name|mux
operator|.
name|MuxUpHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|util
operator|.
name|Rsp
import|;
end_import

begin_import
import|import
name|org
operator|.
name|jgroups
operator|.
name|util
operator|.
name|RspList
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|commons
operator|.
name|hibernate
operator|.
name|util
operator|.
name|HibernateUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|commons
operator|.
name|jgroups
operator|.
name|UniTimeChannelLookup
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|ApplicationProperties
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|defaults
operator|.
name|ApplicationProperty
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|interfaces
operator|.
name|RoomAvailabilityInterface
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|model
operator|.
name|ApplicationConfig
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|model
operator|.
name|StudentSectioningPref
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|model
operator|.
name|SolverParameterGroup
operator|.
name|SolverType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|onlinesectioning
operator|.
name|OnlineSectioningServer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|solver
operator|.
name|SolverProxy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|solver
operator|.
name|exam
operator|.
name|ExamSolverProxy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|solver
operator|.
name|instructor
operator|.
name|InstructorSchedulingProxy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|solver
operator|.
name|service
operator|.
name|SolverServerService
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|solver
operator|.
name|studentsct
operator|.
name|StudentSolverProxy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|spring
operator|.
name|SpringApplicationContextHolder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|util
operator|.
name|MessageLogAppender
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|util
operator|.
name|queue
operator|.
name|QueueProcessor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|util
operator|.
name|queue
operator|.
name|RemoteQueueProcessor
import|;
end_import

begin_comment
comment|/**  * @author Tomas Muller  */
end_comment

begin_class
specifier|public
class|class
name|SolverServerImplementation
extends|extends
name|AbstractSolverServer
implements|implements
name|MessageListener
implements|,
name|MembershipListener
implements|,
name|Receiver
block|{
specifier|private
specifier|static
name|Log
name|sLog
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|SolverServerImplementation
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|private
specifier|static
name|SolverServerImplementation
name|sInstance
init|=
literal|null
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|RequestOptions
name|sFirstResponse
init|=
operator|new
name|RequestOptions
argument_list|(
name|ResponseMode
operator|.
name|GET_FIRST
argument_list|,
name|ApplicationProperty
operator|.
name|SolverClusterTimeout
operator|.
name|intValue
argument_list|()
argument_list|)
operator|.
name|setFlags
argument_list|(
name|Flag
operator|.
name|DONT_BUNDLE
argument_list|,
name|Flag
operator|.
name|OOB
argument_list|)
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|RequestOptions
name|sAllResponses
init|=
operator|new
name|RequestOptions
argument_list|(
name|ResponseMode
operator|.
name|GET_ALL
argument_list|,
name|ApplicationProperty
operator|.
name|SolverClusterTimeout
operator|.
name|intValue
argument_list|()
argument_list|)
operator|.
name|setFlags
argument_list|(
name|Flag
operator|.
name|DONT_BUNDLE
argument_list|,
name|Flag
operator|.
name|OOB
argument_list|)
decl_stmt|;
specifier|private
name|JChannel
name|iChannel
decl_stmt|;
specifier|private
name|RpcDispatcher
name|iDispatcher
decl_stmt|;
specifier|private
name|CourseSolverContainerRemote
name|iCourseSolverContainer
decl_stmt|;
specifier|private
name|ExaminationSolverContainerRemote
name|iExamSolverContainer
decl_stmt|;
specifier|private
name|StudentSolverContainerRemote
name|iStudentSolverContainer
decl_stmt|;
specifier|private
name|InstructorSchedulingContainerRemote
name|iInstructorSchedulingContainer
decl_stmt|;
specifier|private
name|OnlineStudentSchedulingContainerRemote
name|iOnlineStudentSchedulingContainer
decl_stmt|;
specifier|private
name|RemoteRoomAvailability
name|iRemoteRoomAvailability
decl_stmt|;
specifier|private
name|OnlineStudentSchedulingGenericUpdater
name|iUpdater
decl_stmt|;
specifier|private
name|RemoteQueueProcessor
name|iRemoteQueueProcessor
decl_stmt|;
specifier|protected
name|boolean
name|iLocal
init|=
literal|false
decl_stmt|;
specifier|public
name|SolverServerImplementation
parameter_list|(
name|boolean
name|local
parameter_list|,
name|JChannel
name|channel
parameter_list|)
block|{
name|super
argument_list|()
expr_stmt|;
name|iLocal
operator|=
name|local
expr_stmt|;
name|iChannel
operator|=
name|channel
expr_stmt|;
comment|// iChannel.setReceiver(this);
name|iChannel
operator|.
name|setUpHandler
argument_list|(
operator|new
name|MuxUpHandler
argument_list|()
argument_list|)
expr_stmt|;
name|iDispatcher
operator|=
operator|new
name|MuxRpcDispatcher
argument_list|(
name|SCOPE_SERVER
argument_list|,
name|channel
argument_list|,
name|this
argument_list|,
name|this
argument_list|,
name|this
argument_list|)
expr_stmt|;
name|iCourseSolverContainer
operator|=
operator|new
name|CourseSolverContainerRemote
argument_list|(
name|channel
argument_list|,
name|SCOPE_COURSE
argument_list|,
name|local
argument_list|)
expr_stmt|;
name|iExamSolverContainer
operator|=
operator|new
name|ExaminationSolverContainerRemote
argument_list|(
name|channel
argument_list|,
name|SCOPE_EXAM
argument_list|)
expr_stmt|;
name|iStudentSolverContainer
operator|=
operator|new
name|StudentSolverContainerRemote
argument_list|(
name|channel
argument_list|,
name|SCOPE_STUDENT
argument_list|)
expr_stmt|;
name|iInstructorSchedulingContainer
operator|=
operator|new
name|InstructorSchedulingContainerRemote
argument_list|(
name|channel
argument_list|,
name|SCOPE_INSTRUCTOR
argument_list|)
expr_stmt|;
name|iOnlineStudentSchedulingContainer
operator|=
operator|new
name|OnlineStudentSchedulingContainerRemote
argument_list|(
name|channel
argument_list|,
name|SCOPE_ONLINE
argument_list|)
expr_stmt|;
name|iRemoteRoomAvailability
operator|=
operator|new
name|RemoteRoomAvailability
argument_list|(
name|channel
argument_list|,
name|SCOPE_AVAILABILITY
argument_list|)
expr_stmt|;
name|iUpdater
operator|=
operator|new
name|OnlineStudentSchedulingGenericUpdater
argument_list|(
name|iDispatcher
argument_list|,
name|iOnlineStudentSchedulingContainer
argument_list|)
expr_stmt|;
name|iRemoteQueueProcessor
operator|=
operator|new
name|RemoteQueueProcessor
argument_list|(
name|channel
argument_list|,
name|SCOPE_QUEUE_PROCESSOR
argument_list|)
expr_stmt|;
block|}
specifier|public
name|JChannel
name|getChannel
parameter_list|()
block|{
return|return
name|iChannel
return|;
block|}
specifier|public
name|RpcDispatcher
name|getDispatcher
parameter_list|()
block|{
return|return
name|iDispatcher
return|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|start
parameter_list|()
block|{
name|iCourseSolverContainer
operator|.
name|start
argument_list|()
expr_stmt|;
name|iExamSolverContainer
operator|.
name|start
argument_list|()
expr_stmt|;
name|iStudentSolverContainer
operator|.
name|start
argument_list|()
expr_stmt|;
name|iInstructorSchedulingContainer
operator|.
name|start
argument_list|()
expr_stmt|;
name|iOnlineStudentSchedulingContainer
operator|.
name|start
argument_list|()
expr_stmt|;
name|iUpdater
operator|.
name|start
argument_list|()
expr_stmt|;
name|super
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|stop
parameter_list|()
block|{
name|super
operator|.
name|stop
argument_list|()
expr_stmt|;
name|iCourseSolverContainer
operator|.
name|stop
argument_list|()
expr_stmt|;
name|iExamSolverContainer
operator|.
name|stop
argument_list|()
expr_stmt|;
name|iStudentSolverContainer
operator|.
name|stop
argument_list|()
expr_stmt|;
name|iInstructorSchedulingContainer
operator|.
name|stop
argument_list|()
expr_stmt|;
name|iOnlineStudentSchedulingContainer
operator|.
name|stop
argument_list|()
expr_stmt|;
name|iUpdater
operator|.
name|stopUpdating
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|boolean
name|isLocal
parameter_list|()
block|{
return|return
name|iLocal
return|;
block|}
annotation|@
name|Override
specifier|public
name|Address
name|getAddress
parameter_list|()
block|{
return|return
name|iChannel
operator|.
name|getAddress
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|Address
name|getLocalAddress
parameter_list|()
block|{
if|if
condition|(
name|isLocal
argument_list|()
condition|)
return|return
name|getAddress
argument_list|()
return|;
try|try
block|{
name|RspList
argument_list|<
name|Boolean
argument_list|>
name|ret
init|=
name|iDispatcher
operator|.
name|callRemoteMethods
argument_list|(
literal|null
argument_list|,
literal|"isLocal"
argument_list|,
operator|new
name|Object
index|[]
block|{}
argument_list|,
operator|new
name|Class
index|[]
block|{}
argument_list|,
name|sAllResponses
argument_list|)
decl_stmt|;
for|for
control|(
name|Rsp
argument_list|<
name|Boolean
argument_list|>
name|local
range|:
name|ret
control|)
block|{
if|if
condition|(
name|Boolean
operator|.
name|TRUE
operator|.
name|equals
argument_list|(
name|local
operator|.
name|getValue
argument_list|()
argument_list|)
condition|)
return|return
name|local
operator|.
name|getSender
argument_list|()
return|;
block|}
return|return
literal|null
return|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|sLog
operator|.
name|error
argument_list|(
literal|"Failed to retrieve local address: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|boolean
name|isLocalCoordinator
parameter_list|()
block|{
if|if
condition|(
operator|!
name|isLocal
argument_list|()
condition|)
return|return
literal|false
return|;
try|try
block|{
name|int
name|myIndex
init|=
name|iChannel
operator|.
name|getView
argument_list|()
operator|.
name|getMembers
argument_list|()
operator|.
name|indexOf
argument_list|(
name|iChannel
operator|.
name|getAddress
argument_list|()
argument_list|)
decl_stmt|;
name|RspList
argument_list|<
name|Boolean
argument_list|>
name|ret
init|=
name|iDispatcher
operator|.
name|callRemoteMethods
argument_list|(
literal|null
argument_list|,
literal|"isLocal"
argument_list|,
operator|new
name|Object
index|[]
block|{}
argument_list|,
operator|new
name|Class
index|[]
block|{}
argument_list|,
name|sAllResponses
argument_list|)
decl_stmt|;
for|for
control|(
name|Rsp
argument_list|<
name|Boolean
argument_list|>
name|local
range|:
name|ret
control|)
block|{
if|if
condition|(
name|Boolean
operator|.
name|TRUE
operator|.
name|equals
argument_list|(
name|local
operator|.
name|getValue
argument_list|()
argument_list|)
condition|)
block|{
name|int
name|idx
init|=
name|iChannel
operator|.
name|getView
argument_list|()
operator|.
name|getMembers
argument_list|()
operator|.
name|indexOf
argument_list|(
name|local
operator|.
name|getSender
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|idx
operator|<
name|myIndex
condition|)
return|return
literal|false
return|;
block|}
block|}
return|return
literal|true
return|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|sLog
operator|.
name|error
argument_list|(
literal|"Failed to retrieve local address: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|String
name|getHost
parameter_list|()
block|{
return|return
name|iChannel
operator|.
name|getAddressAsString
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|int
name|getUsage
parameter_list|()
block|{
name|int
name|ret
init|=
name|super
operator|.
name|getUsage
argument_list|()
decl_stmt|;
name|ret
operator|+=
name|iCourseSolverContainer
operator|.
name|getUsage
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|iExamSolverContainer
operator|.
name|getUsage
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|iStudentSolverContainer
operator|.
name|getUsage
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|iInstructorSchedulingContainer
operator|.
name|getUsage
argument_list|()
expr_stmt|;
name|ret
operator|+=
name|iOnlineStudentSchedulingContainer
operator|.
name|getUsage
argument_list|()
expr_stmt|;
return|return
name|ret
return|;
block|}
specifier|public
name|List
argument_list|<
name|SolverServer
argument_list|>
name|getServers
parameter_list|(
name|boolean
name|onlyAvailable
parameter_list|)
block|{
name|List
argument_list|<
name|SolverServer
argument_list|>
name|servers
init|=
operator|new
name|ArrayList
argument_list|<
name|SolverServer
argument_list|>
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|onlyAvailable
operator|||
name|isActive
argument_list|()
condition|)
name|servers
operator|.
name|add
argument_list|(
name|this
argument_list|)
expr_stmt|;
for|for
control|(
name|Address
name|address
range|:
name|iChannel
operator|.
name|getView
argument_list|()
operator|.
name|getMembers
argument_list|()
control|)
block|{
if|if
condition|(
name|address
operator|.
name|equals
argument_list|(
name|iChannel
operator|.
name|getAddress
argument_list|()
argument_list|)
condition|)
continue|continue;
name|SolverServer
name|server
init|=
name|crateServerProxy
argument_list|(
name|address
argument_list|)
decl_stmt|;
if|if
condition|(
name|onlyAvailable
operator|&&
operator|!
name|server
operator|.
name|isAvailable
argument_list|()
condition|)
continue|continue;
name|servers
operator|.
name|add
argument_list|(
name|server
argument_list|)
expr_stmt|;
block|}
return|return
name|servers
return|;
block|}
specifier|public
name|SolverServer
name|crateServerProxy
parameter_list|(
name|Address
name|address
parameter_list|)
block|{
name|ServerInvocationHandler
name|handler
init|=
operator|new
name|ServerInvocationHandler
argument_list|(
name|address
argument_list|)
decl_stmt|;
name|SolverServer
name|px
init|=
operator|(
name|SolverServer
operator|)
name|Proxy
operator|.
name|newProxyInstance
argument_list|(
name|SolverServerImplementation
operator|.
name|class
operator|.
name|getClassLoader
argument_list|()
argument_list|,
operator|new
name|Class
index|[]
block|{
name|SolverServer
operator|.
name|class
block|}
argument_list|,
name|handler
argument_list|)
decl_stmt|;
return|return
name|px
return|;
block|}
annotation|@
name|Override
specifier|public
name|SolverContainer
argument_list|<
name|SolverProxy
argument_list|>
name|getCourseSolverContainer
parameter_list|()
block|{
return|return
name|iCourseSolverContainer
return|;
block|}
specifier|public
name|SolverContainer
argument_list|<
name|SolverProxy
argument_list|>
name|createCourseSolverContainerProxy
parameter_list|(
name|Address
name|address
parameter_list|)
block|{
name|ContainerInvocationHandler
argument_list|<
name|RemoteSolverContainer
argument_list|<
name|SolverProxy
argument_list|>
argument_list|>
name|handler
init|=
operator|new
name|ContainerInvocationHandler
argument_list|<
name|RemoteSolverContainer
argument_list|<
name|SolverProxy
argument_list|>
argument_list|>
argument_list|(
name|address
argument_list|,
name|iCourseSolverContainer
argument_list|)
decl_stmt|;
name|SolverContainer
argument_list|<
name|SolverProxy
argument_list|>
name|px
init|=
operator|(
name|SolverContainer
argument_list|<
name|SolverProxy
argument_list|>
operator|)
name|Proxy
operator|.
name|newProxyInstance
argument_list|(
name|SolverServerImplementation
operator|.
name|class
operator|.
name|getClassLoader
argument_list|()
argument_list|,
operator|new
name|Class
index|[]
block|{
name|SolverContainer
operator|.
name|class
block|}
argument_list|,
name|handler
argument_list|)
decl_stmt|;
return|return
name|px
return|;
block|}
annotation|@
name|Override
specifier|public
name|SolverContainer
argument_list|<
name|ExamSolverProxy
argument_list|>
name|getExamSolverContainer
parameter_list|()
block|{
return|return
name|iExamSolverContainer
return|;
block|}
specifier|public
name|SolverContainer
argument_list|<
name|ExamSolverProxy
argument_list|>
name|createExamSolverContainerProxy
parameter_list|(
name|Address
name|address
parameter_list|)
block|{
name|ContainerInvocationHandler
argument_list|<
name|RemoteSolverContainer
argument_list|<
name|ExamSolverProxy
argument_list|>
argument_list|>
name|handler
init|=
operator|new
name|ContainerInvocationHandler
argument_list|<
name|RemoteSolverContainer
argument_list|<
name|ExamSolverProxy
argument_list|>
argument_list|>
argument_list|(
name|address
argument_list|,
name|iExamSolverContainer
argument_list|)
decl_stmt|;
name|SolverContainer
argument_list|<
name|ExamSolverProxy
argument_list|>
name|px
init|=
operator|(
name|SolverContainer
argument_list|<
name|ExamSolverProxy
argument_list|>
operator|)
name|Proxy
operator|.
name|newProxyInstance
argument_list|(
name|SolverServerImplementation
operator|.
name|class
operator|.
name|getClassLoader
argument_list|()
argument_list|,
operator|new
name|Class
index|[]
block|{
name|SolverContainer
operator|.
name|class
block|}
argument_list|,
name|handler
argument_list|)
decl_stmt|;
return|return
name|px
return|;
block|}
annotation|@
name|Override
specifier|public
name|SolverContainer
argument_list|<
name|InstructorSchedulingProxy
argument_list|>
name|getInstructorSchedulingContainer
parameter_list|()
block|{
return|return
name|iInstructorSchedulingContainer
return|;
block|}
specifier|public
name|SolverContainer
argument_list|<
name|InstructorSchedulingProxy
argument_list|>
name|createInstructorSchedulingContainerProxy
parameter_list|(
name|Address
name|address
parameter_list|)
block|{
name|ContainerInvocationHandler
argument_list|<
name|RemoteSolverContainer
argument_list|<
name|InstructorSchedulingProxy
argument_list|>
argument_list|>
name|handler
init|=
operator|new
name|ContainerInvocationHandler
argument_list|<
name|RemoteSolverContainer
argument_list|<
name|InstructorSchedulingProxy
argument_list|>
argument_list|>
argument_list|(
name|address
argument_list|,
name|iInstructorSchedulingContainer
argument_list|)
decl_stmt|;
name|SolverContainer
argument_list|<
name|InstructorSchedulingProxy
argument_list|>
name|px
init|=
operator|(
name|SolverContainer
argument_list|<
name|InstructorSchedulingProxy
argument_list|>
operator|)
name|Proxy
operator|.
name|newProxyInstance
argument_list|(
name|SolverServerImplementation
operator|.
name|class
operator|.
name|getClassLoader
argument_list|()
argument_list|,
operator|new
name|Class
index|[]
block|{
name|SolverContainer
operator|.
name|class
block|}
argument_list|,
name|handler
argument_list|)
decl_stmt|;
return|return
name|px
return|;
block|}
annotation|@
name|Override
specifier|public
name|SolverContainer
argument_list|<
name|StudentSolverProxy
argument_list|>
name|getStudentSolverContainer
parameter_list|()
block|{
return|return
name|iStudentSolverContainer
return|;
block|}
specifier|public
name|SolverContainer
argument_list|<
name|StudentSolverProxy
argument_list|>
name|createStudentSolverContainerProxy
parameter_list|(
name|Address
name|address
parameter_list|)
block|{
name|ContainerInvocationHandler
argument_list|<
name|RemoteSolverContainer
argument_list|<
name|StudentSolverProxy
argument_list|>
argument_list|>
name|handler
init|=
operator|new
name|ContainerInvocationHandler
argument_list|<
name|RemoteSolverContainer
argument_list|<
name|StudentSolverProxy
argument_list|>
argument_list|>
argument_list|(
name|address
argument_list|,
name|iStudentSolverContainer
argument_list|)
decl_stmt|;
name|SolverContainer
argument_list|<
name|StudentSolverProxy
argument_list|>
name|px
init|=
operator|(
name|SolverContainer
argument_list|<
name|StudentSolverProxy
argument_list|>
operator|)
name|Proxy
operator|.
name|newProxyInstance
argument_list|(
name|SolverServerImplementation
operator|.
name|class
operator|.
name|getClassLoader
argument_list|()
argument_list|,
operator|new
name|Class
index|[]
block|{
name|SolverContainer
operator|.
name|class
block|}
argument_list|,
name|handler
argument_list|)
decl_stmt|;
return|return
name|px
return|;
block|}
annotation|@
name|Override
specifier|public
name|SolverContainer
argument_list|<
name|OnlineSectioningServer
argument_list|>
name|getOnlineStudentSchedulingContainer
parameter_list|()
block|{
return|return
name|iOnlineStudentSchedulingContainer
return|;
block|}
specifier|public
name|SolverContainer
argument_list|<
name|OnlineSectioningServer
argument_list|>
name|createOnlineStudentSchedulingContainerProxy
parameter_list|(
name|Address
name|address
parameter_list|)
block|{
name|ContainerInvocationHandler
argument_list|<
name|RemoteSolverContainer
argument_list|<
name|OnlineSectioningServer
argument_list|>
argument_list|>
name|handler
init|=
operator|new
name|ContainerInvocationHandler
argument_list|<
name|RemoteSolverContainer
argument_list|<
name|OnlineSectioningServer
argument_list|>
argument_list|>
argument_list|(
name|address
argument_list|,
name|iOnlineStudentSchedulingContainer
argument_list|)
decl_stmt|;
name|SolverContainer
argument_list|<
name|OnlineSectioningServer
argument_list|>
name|px
init|=
operator|(
name|SolverContainer
argument_list|<
name|OnlineSectioningServer
argument_list|>
operator|)
name|Proxy
operator|.
name|newProxyInstance
argument_list|(
name|SolverServerImplementation
operator|.
name|class
operator|.
name|getClassLoader
argument_list|()
argument_list|,
operator|new
name|Class
index|[]
block|{
name|SolverContainer
operator|.
name|class
block|}
argument_list|,
name|handler
argument_list|)
decl_stmt|;
return|return
name|px
return|;
block|}
annotation|@
name|Override
specifier|public
name|RoomAvailabilityInterface
name|getRoomAvailability
parameter_list|()
block|{
if|if
condition|(
name|isLocal
argument_list|()
condition|)
return|return
name|super
operator|.
name|getRoomAvailability
argument_list|()
return|;
name|Address
name|local
init|=
name|getLocalAddress
argument_list|()
decl_stmt|;
if|if
condition|(
name|local
operator|!=
literal|null
condition|)
return|return
operator|(
name|RoomAvailabilityInterface
operator|)
name|Proxy
operator|.
name|newProxyInstance
argument_list|(
name|SolverServerImplementation
operator|.
name|class
operator|.
name|getClassLoader
argument_list|()
argument_list|,
operator|new
name|Class
index|[]
block|{
name|RoomAvailabilityInterface
operator|.
name|class
block|}
argument_list|,
operator|new
name|RoomAvailabilityInvocationHandler
argument_list|(
name|local
argument_list|,
name|iRemoteRoomAvailability
argument_list|)
argument_list|)
return|;
return|return
literal|null
return|;
block|}
specifier|public
name|void
name|refreshCourseSolutionLocal
parameter_list|(
name|Long
modifier|...
name|solutionIds
parameter_list|)
block|{
if|if
condition|(
name|isLocal
argument_list|()
condition|)
name|super
operator|.
name|refreshCourseSolution
argument_list|(
name|solutionIds
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|refreshCourseSolution
parameter_list|(
name|Long
modifier|...
name|solutionIds
parameter_list|)
block|{
try|try
block|{
name|iDispatcher
operator|.
name|callRemoteMethods
argument_list|(
literal|null
argument_list|,
literal|"refreshCourseSolutionLocal"
argument_list|,
operator|new
name|Object
index|[]
block|{
name|solutionIds
block|}
argument_list|,
operator|new
name|Class
index|[]
block|{
name|Long
index|[]
operator|.
expr|class
block|}
argument_list|,
name|sAllResponses
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|sLog
operator|.
name|error
argument_list|(
literal|"Failed to refresh solution: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|void
name|refreshExamSolutionLocal
parameter_list|(
name|Long
name|sessionId
parameter_list|,
name|Long
name|examTypeId
parameter_list|)
block|{
if|if
condition|(
name|isLocal
argument_list|()
condition|)
name|super
operator|.
name|refreshExamSolution
argument_list|(
name|sessionId
argument_list|,
name|examTypeId
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|refreshExamSolution
parameter_list|(
name|Long
name|sessionId
parameter_list|,
name|Long
name|examTypeId
parameter_list|)
block|{
try|try
block|{
name|iDispatcher
operator|.
name|callRemoteMethods
argument_list|(
literal|null
argument_list|,
literal|"refreshExamSolutionLocal"
argument_list|,
operator|new
name|Object
index|[]
block|{
name|sessionId
block|,
name|examTypeId
block|}
argument_list|,
operator|new
name|Class
index|[]
block|{
name|Long
operator|.
name|class
block|,
name|Long
operator|.
name|class
block|}
argument_list|,
name|sAllResponses
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|sLog
operator|.
name|error
argument_list|(
literal|"Failed to refresh solution: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|void
name|refreshInstructorSolutionLocal
parameter_list|(
name|Collection
argument_list|<
name|Long
argument_list|>
name|solverGroupIds
parameter_list|)
block|{
if|if
condition|(
name|isLocal
argument_list|()
condition|)
name|super
operator|.
name|refreshInstructorSolution
argument_list|(
name|solverGroupIds
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|refreshInstructorSolution
parameter_list|(
name|Collection
argument_list|<
name|Long
argument_list|>
name|solverGroupIds
parameter_list|)
block|{
try|try
block|{
name|iDispatcher
operator|.
name|callRemoteMethods
argument_list|(
literal|null
argument_list|,
literal|"refreshInstructorSolutionLocal"
argument_list|,
operator|new
name|Object
index|[]
block|{
name|solverGroupIds
block|}
argument_list|,
operator|new
name|Class
index|[]
block|{
name|Collection
operator|.
name|class
block|}
argument_list|,
name|sAllResponses
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|sLog
operator|.
name|error
argument_list|(
literal|"Failed to refresh solution: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|void
name|unloadSolverLocal
parameter_list|(
name|Integer
name|type
parameter_list|,
name|String
name|id
parameter_list|)
block|{
switch|switch
condition|(
name|SolverType
operator|.
name|values
argument_list|()
index|[
name|type
index|]
condition|)
block|{
case|case
name|COURSE
case|:
name|getCourseSolverContainer
argument_list|()
operator|.
name|unloadSolver
argument_list|(
name|id
argument_list|)
expr_stmt|;
break|break;
case|case
name|EXAM
case|:
name|getExamSolverContainer
argument_list|()
operator|.
name|unloadSolver
argument_list|(
name|id
argument_list|)
expr_stmt|;
break|break;
case|case
name|INSTRUCTOR
case|:
name|getInstructorSchedulingContainer
argument_list|()
operator|.
name|unloadSolver
argument_list|(
name|id
argument_list|)
expr_stmt|;
break|break;
case|case
name|STUDENT
case|:
name|getStudentSolverContainer
argument_list|()
operator|.
name|unloadSolver
argument_list|(
name|id
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|unloadSolver
parameter_list|(
name|SolverType
name|type
parameter_list|,
name|String
name|id
parameter_list|)
block|{
try|try
block|{
name|iDispatcher
operator|.
name|callRemoteMethods
argument_list|(
literal|null
argument_list|,
literal|"unloadSolverLocal"
argument_list|,
operator|new
name|Object
index|[]
block|{
name|type
operator|.
name|ordinal
argument_list|()
block|,
name|id
block|}
argument_list|,
operator|new
name|Class
index|[]
block|{
name|Integer
operator|.
name|class
block|,
name|String
operator|.
name|class
block|}
argument_list|,
name|sAllResponses
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|sLog
operator|.
name|error
argument_list|(
literal|"Failed to unload solver: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
specifier|static
class|class
name|RoomAvailabilityInvocationHandler
implements|implements
name|InvocationHandler
block|{
specifier|private
name|Address
name|iAddress
decl_stmt|;
specifier|private
name|RemoteRoomAvailability
name|iAvailability
decl_stmt|;
specifier|private
name|RoomAvailabilityInvocationHandler
parameter_list|(
name|Address
name|address
parameter_list|,
name|RemoteRoomAvailability
name|availability
parameter_list|)
block|{
name|iAddress
operator|=
name|address
expr_stmt|;
name|iAvailability
operator|=
name|availability
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|Object
name|invoke
parameter_list|(
name|Object
name|proxy
parameter_list|,
name|Method
name|method
parameter_list|,
name|Object
index|[]
name|args
parameter_list|)
throws|throws
name|Throwable
block|{
return|return
name|iAvailability
operator|.
name|dispatch
argument_list|(
name|iAddress
argument_list|,
name|method
argument_list|,
name|args
argument_list|)
return|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|viewAccepted
parameter_list|(
name|View
name|view
parameter_list|)
block|{
name|sLog
operator|.
name|info
argument_list|(
literal|"viewAccepted("
operator|+
name|view
operator|+
literal|")"
argument_list|)
expr_stmt|;
if|if
condition|(
name|view
operator|instanceof
name|MergeView
condition|)
block|{
name|reset
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|suspect
parameter_list|(
name|Address
name|suspected_mbr
parameter_list|)
block|{
name|sLog
operator|.
name|warn
argument_list|(
literal|"suspect("
operator|+
name|suspected_mbr
operator|+
literal|")"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|block
parameter_list|()
block|{
name|sLog
operator|.
name|info
argument_list|(
literal|"block"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|unblock
parameter_list|()
block|{
name|sLog
operator|.
name|info
argument_list|(
literal|"unblock"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|receive
parameter_list|(
name|Message
name|msg
parameter_list|)
block|{
name|sLog
operator|.
name|info
argument_list|(
literal|"receive("
operator|+
name|msg
operator|+
literal|", "
operator|+
name|msg
operator|.
name|getObject
argument_list|()
operator|+
literal|")"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|getState
parameter_list|(
name|OutputStream
name|output
parameter_list|)
throws|throws
name|Exception
block|{
block|}
annotation|@
name|Override
specifier|public
name|void
name|setState
parameter_list|(
name|InputStream
name|input
parameter_list|)
throws|throws
name|Exception
block|{
block|}
specifier|public
class|class
name|ServerInvocationHandler
implements|implements
name|InvocationHandler
block|{
specifier|private
name|Address
name|iAddress
decl_stmt|;
specifier|public
name|ServerInvocationHandler
parameter_list|(
name|Address
name|address
parameter_list|)
block|{
name|iAddress
operator|=
name|address
expr_stmt|;
block|}
specifier|public
name|SolverContainer
argument_list|<
name|SolverProxy
argument_list|>
name|getCourseSolverContainer
parameter_list|()
block|{
return|return
name|createCourseSolverContainerProxy
argument_list|(
name|iAddress
argument_list|)
return|;
block|}
specifier|public
name|SolverContainer
argument_list|<
name|ExamSolverProxy
argument_list|>
name|getExamSolverContainer
parameter_list|()
block|{
return|return
name|createExamSolverContainerProxy
argument_list|(
name|iAddress
argument_list|)
return|;
block|}
specifier|public
name|SolverContainer
argument_list|<
name|StudentSolverProxy
argument_list|>
name|getStudentSolverContainer
parameter_list|()
block|{
return|return
name|createStudentSolverContainerProxy
argument_list|(
name|iAddress
argument_list|)
return|;
block|}
specifier|public
name|SolverContainer
argument_list|<
name|InstructorSchedulingProxy
argument_list|>
name|getInstructorSchedulingContainer
parameter_list|()
block|{
return|return
name|createInstructorSchedulingContainerProxy
argument_list|(
name|iAddress
argument_list|)
return|;
block|}
specifier|public
name|SolverContainer
argument_list|<
name|OnlineSectioningServer
argument_list|>
name|getOnlineStudentSchedulingContainer
parameter_list|()
block|{
return|return
name|createOnlineStudentSchedulingContainerProxy
argument_list|(
name|iAddress
argument_list|)
return|;
block|}
specifier|public
name|Address
name|getAddress
parameter_list|()
block|{
return|return
name|iAddress
return|;
block|}
specifier|public
name|String
name|getHost
parameter_list|()
block|{
return|return
name|iAddress
operator|.
name|toString
argument_list|()
return|;
block|}
specifier|public
name|boolean
name|isActive
parameter_list|()
throws|throws
name|Exception
block|{
try|try
block|{
name|Boolean
name|active
init|=
name|iDispatcher
operator|.
name|callRemoteMethod
argument_list|(
name|iAddress
argument_list|,
literal|"isActive"
argument_list|,
operator|new
name|Object
index|[]
block|{}
argument_list|,
operator|new
name|Class
index|[]
block|{}
argument_list|,
name|sFirstResponse
argument_list|)
decl_stmt|;
return|return
name|active
return|;
block|}
catch|catch
parameter_list|(
name|SuspectedException
name|e
parameter_list|)
block|{
return|return
literal|false
return|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|Object
name|invoke
parameter_list|(
name|Object
name|proxy
parameter_list|,
name|Method
name|method
parameter_list|,
name|Object
index|[]
name|args
parameter_list|)
throws|throws
name|Throwable
block|{
try|try
block|{
return|return
name|getClass
argument_list|()
operator|.
name|getMethod
argument_list|(
name|method
operator|.
name|getName
argument_list|()
argument_list|,
name|method
operator|.
name|getParameterTypes
argument_list|()
argument_list|)
operator|.
name|invoke
argument_list|(
name|this
argument_list|,
name|args
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|NoSuchMethodException
name|e
parameter_list|)
block|{
block|}
return|return
name|iDispatcher
operator|.
name|callRemoteMethod
argument_list|(
name|iAddress
argument_list|,
name|method
operator|.
name|getName
argument_list|()
argument_list|,
name|args
argument_list|,
name|method
operator|.
name|getParameterTypes
argument_list|()
argument_list|,
name|sFirstResponse
argument_list|)
return|;
block|}
block|}
specifier|public
class|class
name|ContainerInvocationHandler
parameter_list|<
name|T
extends|extends
name|RemoteSolverContainer
parameter_list|>
implements|implements
name|InvocationHandler
block|{
specifier|private
name|Address
name|iAddress
decl_stmt|;
specifier|private
name|T
name|iContainer
decl_stmt|;
specifier|private
name|ContainerInvocationHandler
parameter_list|(
name|Address
name|address
parameter_list|,
name|T
name|container
parameter_list|)
block|{
name|iAddress
operator|=
name|address
expr_stmt|;
name|iContainer
operator|=
name|container
expr_stmt|;
block|}
specifier|public
name|Object
name|createSolver
parameter_list|(
name|String
name|user
parameter_list|,
name|DataProperties
name|config
parameter_list|)
throws|throws
name|Throwable
block|{
name|iContainer
operator|.
name|getDispatcher
argument_list|()
operator|.
name|callRemoteMethod
argument_list|(
name|iAddress
argument_list|,
literal|"createRemoteSolver"
argument_list|,
operator|new
name|Object
index|[]
block|{
name|user
block|,
name|config
block|,
name|iChannel
operator|.
name|getAddress
argument_list|()
block|}
argument_list|,
operator|new
name|Class
index|[]
block|{
name|String
operator|.
name|class
block|,
name|DataProperties
operator|.
name|class
block|,
name|Address
operator|.
name|class
block|}
argument_list|,
name|sFirstResponse
argument_list|)
expr_stmt|;
return|return
name|iContainer
operator|.
name|createProxy
argument_list|(
name|iAddress
argument_list|,
operator|(
name|String
operator|)
name|user
argument_list|)
return|;
block|}
specifier|public
name|Address
name|getAddress
parameter_list|()
block|{
return|return
name|iAddress
return|;
block|}
specifier|public
name|String
name|getHost
parameter_list|()
block|{
return|return
name|iAddress
operator|.
name|toString
argument_list|()
return|;
block|}
specifier|public
name|Object
name|getSolver
parameter_list|(
name|String
name|user
parameter_list|)
throws|throws
name|Exception
block|{
name|Boolean
name|ret
init|=
name|iContainer
operator|.
name|getDispatcher
argument_list|()
operator|.
name|callRemoteMethod
argument_list|(
name|iAddress
argument_list|,
literal|"hasSolver"
argument_list|,
operator|new
name|Object
index|[]
block|{
name|user
block|}
argument_list|,
operator|new
name|Class
index|[]
block|{
name|String
operator|.
name|class
block|}
argument_list|,
name|sFirstResponse
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|iContainer
operator|.
name|createProxy
argument_list|(
name|iAddress
argument_list|,
name|user
argument_list|)
return|;
return|return
literal|null
return|;
block|}
annotation|@
name|Override
specifier|public
name|Object
name|invoke
parameter_list|(
name|Object
name|proxy
parameter_list|,
name|Method
name|method
parameter_list|,
name|Object
index|[]
name|args
parameter_list|)
throws|throws
name|Throwable
block|{
try|try
block|{
return|return
name|getClass
argument_list|()
operator|.
name|getMethod
argument_list|(
name|method
operator|.
name|getName
argument_list|()
argument_list|,
name|method
operator|.
name|getParameterTypes
argument_list|()
argument_list|)
operator|.
name|invoke
argument_list|(
name|this
argument_list|,
name|args
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|NoSuchMethodException
name|e
parameter_list|)
block|{
block|}
return|return
name|iContainer
operator|.
name|getDispatcher
argument_list|()
operator|.
name|callRemoteMethod
argument_list|(
name|iAddress
argument_list|,
name|method
operator|.
name|getName
argument_list|()
argument_list|,
name|args
argument_list|,
name|method
operator|.
name|getParameterTypes
argument_list|()
argument_list|,
name|sFirstResponse
argument_list|)
return|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|shutdown
parameter_list|()
block|{
name|iActive
operator|=
literal|false
expr_stmt|;
operator|new
name|ShutdownThread
argument_list|()
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
specifier|public
specifier|static
name|SolverServer
name|getInstance
parameter_list|()
block|{
if|if
condition|(
name|sInstance
operator|==
literal|null
operator|&&
name|SpringApplicationContextHolder
operator|.
name|isInitialized
argument_list|()
condition|)
block|{
return|return
operator|(
operator|(
name|SolverServerService
operator|)
name|SpringApplicationContextHolder
operator|.
name|getBean
argument_list|(
literal|"solverServerService"
argument_list|)
operator|)
operator|.
name|getLocalServer
argument_list|()
return|;
block|}
return|return
name|sInstance
return|;
block|}
specifier|private
class|class
name|ShutdownThread
extends|extends
name|Thread
block|{
name|ShutdownThread
parameter_list|()
block|{
name|setName
argument_list|(
literal|"SolverServer:Shutdown"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
try|try
block|{
name|sleep
argument_list|(
literal|500
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
block|}
name|sLog
operator|.
name|info
argument_list|(
literal|"Server is going down..."
argument_list|)
expr_stmt|;
name|SolverServerImplementation
operator|.
name|this
operator|.
name|stop
argument_list|()
expr_stmt|;
name|sLog
operator|.
name|info
argument_list|(
literal|"Disconnecting from the channel..."
argument_list|)
expr_stmt|;
name|getChannel
argument_list|()
operator|.
name|disconnect
argument_list|()
expr_stmt|;
name|sLog
operator|.
name|info
argument_list|(
literal|"This is the end."
argument_list|)
expr_stmt|;
name|System
operator|.
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|sLog
operator|.
name|error
argument_list|(
literal|"Failed to stop the server: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|private
specifier|static
name|void
name|configureLogging
parameter_list|(
name|Properties
name|properties
parameter_list|)
block|{
name|Logger
name|log
init|=
name|LogManager
operator|.
name|getRootLogger
argument_list|()
decl_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"-----------------------------------------------------------------------"
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"UniTime Log File"
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Created: "
operator|+
operator|new
name|Date
argument_list|()
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"System info:"
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"System:      "
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"os.name"
argument_list|)
operator|+
literal|" "
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"os.version"
argument_list|)
operator|+
literal|" "
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"os.arch"
argument_list|)
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"CPU:         "
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"sun.cpu.isalist"
argument_list|)
operator|+
literal|" endian:"
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"sun.cpu.endian"
argument_list|)
operator|+
literal|" encoding:"
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"sun.io.unicode.encoding"
argument_list|)
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Java:        "
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"java.vendor"
argument_list|)
operator|+
literal|", "
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"java.runtime.name"
argument_list|)
operator|+
literal|" "
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"java.runtime.version"
argument_list|,
name|System
operator|.
name|getProperty
argument_list|(
literal|"java.version"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"User:        "
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"user.name"
argument_list|)
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Timezone:    "
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"user.timezone"
argument_list|)
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Working dir: "
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"user.dir"
argument_list|)
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Classpath:   "
operator|+
name|System
operator|.
name|getProperty
argument_list|(
literal|"java.class.path"
argument_list|)
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Memory:      "
operator|+
operator|(
name|Runtime
operator|.
name|getRuntime
argument_list|()
operator|.
name|maxMemory
argument_list|()
operator|/
literal|1024
operator|/
literal|1024
operator|)
operator|+
literal|" MB"
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Cores:       "
operator|+
name|Runtime
operator|.
name|getRuntime
argument_list|()
operator|.
name|availableProcessors
argument_list|()
argument_list|)
expr_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|""
argument_list|)
expr_stmt|;
block|}
specifier|public
specifier|static
name|void
name|main
parameter_list|(
name|String
index|[]
name|args
parameter_list|)
block|{
try|try
block|{
if|if
condition|(
name|ApplicationProperty
operator|.
name|DataDir
operator|.
name|value
argument_list|()
operator|==
literal|null
condition|)
name|ApplicationProperties
operator|.
name|getDefaultProperties
argument_list|()
operator|.
name|setProperty
argument_list|(
name|ApplicationProperty
operator|.
name|DataDir
operator|.
name|key
argument_list|()
argument_list|,
name|ApplicationProperties
operator|.
name|getProperty
argument_list|(
literal|"tmtbl.solver.home"
argument_list|,
literal|"."
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|System
operator|.
name|getProperty
argument_list|(
literal|"catalina.base"
argument_list|)
operator|==
literal|null
condition|)
name|ApplicationProperties
operator|.
name|getDefaultProperties
argument_list|()
operator|.
name|setProperty
argument_list|(
literal|"catalina.base"
argument_list|,
name|ApplicationProperty
operator|.
name|DataDir
operator|.
name|value
argument_list|()
argument_list|)
expr_stmt|;
name|configureLogging
argument_list|(
name|ApplicationProperties
operator|.
name|getDefaultProperties
argument_list|()
argument_list|)
expr_stmt|;
name|HibernateUtil
operator|.
name|configureHibernate
argument_list|(
name|ApplicationProperties
operator|.
name|getProperties
argument_list|()
argument_list|)
expr_stmt|;
name|ApplicationConfig
operator|.
name|configureLogging
argument_list|()
expr_stmt|;
specifier|final
name|MessageLogAppender
name|appender
init|=
operator|new
name|MessageLogAppender
argument_list|()
decl_stmt|;
name|LoggerContext
name|ctx
init|=
name|LoggerContext
operator|.
name|getContext
argument_list|(
literal|false
argument_list|)
decl_stmt|;
name|Configuration
name|config
init|=
name|ctx
operator|.
name|getConfiguration
argument_list|()
decl_stmt|;
name|config
operator|.
name|addAppender
argument_list|(
name|appender
argument_list|)
expr_stmt|;
name|config
operator|.
name|getRootLogger
argument_list|()
operator|.
name|addAppender
argument_list|(
name|appender
argument_list|,
name|appender
operator|.
name|getMinLevel
argument_list|()
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|ctx
operator|.
name|updateLoggers
argument_list|()
expr_stmt|;
name|appender
operator|.
name|start
argument_list|()
expr_stmt|;
name|StudentSectioningPref
operator|.
name|updateStudentSectioningPreferences
argument_list|()
expr_stmt|;
specifier|final
name|JChannel
name|channel
init|=
operator|(
name|JChannel
operator|)
operator|new
name|UniTimeChannelLookup
argument_list|()
operator|.
name|getJGroupsChannel
argument_list|(
literal|null
argument_list|)
decl_stmt|;
name|sInstance
operator|=
operator|new
name|SolverServerImplementation
argument_list|(
literal|false
argument_list|,
name|channel
argument_list|)
expr_stmt|;
name|channel
operator|.
name|connect
argument_list|(
literal|"UniTime:rpc"
argument_list|)
expr_stmt|;
name|channel
operator|.
name|getState
argument_list|(
literal|null
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sInstance
operator|.
name|start
argument_list|()
expr_stmt|;
name|Runtime
operator|.
name|getRuntime
argument_list|()
operator|.
name|addShutdownHook
argument_list|(
operator|new
name|Thread
argument_list|()
block|{
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
name|sInstance
operator|.
name|iActive
operator|=
literal|false
expr_stmt|;
name|sLog
operator|.
name|info
argument_list|(
literal|"Server is going down..."
argument_list|)
expr_stmt|;
name|sInstance
operator|.
name|stop
argument_list|()
expr_stmt|;
name|sLog
operator|.
name|info
argument_list|(
literal|"Disconnecting from the channel..."
argument_list|)
expr_stmt|;
name|channel
operator|.
name|disconnect
argument_list|()
expr_stmt|;
name|sLog
operator|.
name|info
argument_list|(
literal|"Closing the channel..."
argument_list|)
expr_stmt|;
name|channel
operator|.
name|close
argument_list|()
expr_stmt|;
name|sLog
operator|.
name|info
argument_list|(
literal|"Stopping message log appender..."
argument_list|)
expr_stmt|;
name|appender
operator|.
name|stop
argument_list|()
expr_stmt|;
name|sLog
operator|.
name|info
argument_list|(
literal|"Closing hibernate..."
argument_list|)
expr_stmt|;
name|HibernateUtil
operator|.
name|closeHibernate
argument_list|()
expr_stmt|;
name|sLog
operator|.
name|info
argument_list|(
literal|"This is the end."
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|sLog
operator|.
name|error
argument_list|(
literal|"Failed to stop the server: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|sLog
operator|.
name|error
argument_list|(
literal|"Failed to start the server: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|boolean
name|isCoordinator
parameter_list|()
block|{
return|return
operator|(
name|iUpdater
operator|!=
literal|null
operator|&&
name|iUpdater
operator|.
name|isCoordinator
argument_list|()
operator|)
return|;
block|}
annotation|@
name|Override
specifier|public
specifier|synchronized
name|void
name|reset
parameter_list|()
block|{
name|sLog
operator|.
name|info
argument_list|(
name|iOnlineStudentSchedulingContainer
operator|.
name|getLockService
argument_list|()
operator|.
name|printLocks
argument_list|()
argument_list|)
expr_stmt|;
comment|// For each of my online student sectioning solvers
for|for
control|(
name|String
name|session
range|:
name|iOnlineStudentSchedulingContainer
operator|.
name|getSolvers
argument_list|()
control|)
block|{
name|OnlineSectioningServer
name|server
init|=
name|iOnlineStudentSchedulingContainer
operator|.
name|getSolver
argument_list|(
name|session
argument_list|)
decl_stmt|;
if|if
condition|(
name|server
operator|==
literal|null
condition|)
continue|continue;
comment|// mark server for reload and release the lock
if|if
condition|(
name|server
operator|.
name|isMaster
argument_list|()
condition|)
block|{
if|if
condition|(
name|ApplicationProperty
operator|.
name|OnlineSchedulingReloadAfterMerge
operator|.
name|isTrue
argument_list|()
condition|)
block|{
name|sLog
operator|.
name|info
argument_list|(
literal|"Marking "
operator|+
name|server
operator|.
name|getAcademicSession
argument_list|()
operator|+
literal|" for reload"
argument_list|)
expr_stmt|;
name|server
operator|.
name|setProperty
argument_list|(
literal|"ReadyToServe"
argument_list|,
name|Boolean
operator|.
name|FALSE
argument_list|)
expr_stmt|;
name|server
operator|.
name|setProperty
argument_list|(
literal|"ReloadIsNeeded"
argument_list|,
name|Boolean
operator|.
name|TRUE
argument_list|)
expr_stmt|;
block|}
name|sLog
operator|.
name|info
argument_list|(
literal|"Releasing master lock for "
operator|+
name|server
operator|.
name|getAcademicSession
argument_list|()
operator|+
literal|" ..."
argument_list|)
expr_stmt|;
name|server
operator|.
name|releaseMasterLockIfHeld
argument_list|()
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|setApplicationProperty
parameter_list|(
name|Long
name|sessionId
parameter_list|,
name|String
name|key
parameter_list|,
name|String
name|value
parameter_list|)
block|{
name|sLog
operator|.
name|info
argument_list|(
literal|"Set "
operator|+
name|key
operator|+
literal|" to "
operator|+
name|value
operator|+
operator|(
name|sessionId
operator|==
literal|null
condition|?
literal|""
else|:
literal|" (for session "
operator|+
name|sessionId
operator|+
literal|")"
operator|)
argument_list|)
expr_stmt|;
name|Properties
name|properties
init|=
operator|(
name|sessionId
operator|==
literal|null
condition|?
name|ApplicationProperties
operator|.
name|getConfigProperties
argument_list|()
else|:
name|ApplicationProperties
operator|.
name|getSessionProperties
argument_list|(
name|sessionId
argument_list|)
operator|)
decl_stmt|;
if|if
condition|(
name|properties
operator|==
literal|null
condition|)
return|return;
if|if
condition|(
name|value
operator|==
literal|null
condition|)
name|properties
operator|.
name|remove
argument_list|(
name|key
argument_list|)
expr_stmt|;
else|else
name|properties
operator|.
name|setProperty
argument_list|(
name|key
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|setLoggingLevel
parameter_list|(
name|String
name|name
parameter_list|,
name|String
name|level
parameter_list|)
block|{
name|sLog
operator|.
name|info
argument_list|(
literal|"Set logging level for "
operator|+
operator|(
name|name
operator|==
literal|null
condition|?
literal|"root"
else|:
name|name
operator|)
operator|+
literal|" to "
operator|+
operator|(
name|level
operator|==
literal|null
condition|?
literal|"null"
else|:
name|level
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|level
operator|==
literal|null
condition|)
block|{
if|if
condition|(
name|name
operator|==
literal|null
operator|||
name|name
operator|.
name|isEmpty
argument_list|()
condition|)
name|Configurator
operator|.
name|setRootLevel
argument_list|(
name|Level
operator|.
name|INFO
argument_list|)
expr_stmt|;
else|else
name|Configurator
operator|.
name|setLevel
argument_list|(
name|name
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|name
operator|==
literal|null
operator|||
name|name
operator|.
name|isEmpty
argument_list|()
condition|)
name|Configurator
operator|.
name|setRootLevel
argument_list|(
name|Level
operator|.
name|getLevel
argument_list|(
name|level
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|Configurator
operator|.
name|setLevel
argument_list|(
name|name
argument_list|,
name|Level
operator|.
name|getLevel
argument_list|(
name|level
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|QueueProcessor
name|getQueueProcessor
parameter_list|()
block|{
name|Address
name|local
init|=
name|getLocalAddress
argument_list|()
decl_stmt|;
if|if
condition|(
name|local
operator|!=
literal|null
condition|)
return|return
operator|(
name|QueueProcessor
operator|)
name|Proxy
operator|.
name|newProxyInstance
argument_list|(
name|SolverServerImplementation
operator|.
name|class
operator|.
name|getClassLoader
argument_list|()
argument_list|,
operator|new
name|Class
index|[]
block|{
name|QueueProcessor
operator|.
name|class
block|}
argument_list|,
operator|new
name|QueueProcessorInvocationHandler
argument_list|(
name|local
argument_list|,
name|iRemoteQueueProcessor
argument_list|)
argument_list|)
return|;
return|return
name|super
operator|.
name|getQueueProcessor
argument_list|()
return|;
block|}
specifier|public
specifier|static
class|class
name|QueueProcessorInvocationHandler
implements|implements
name|InvocationHandler
block|{
specifier|private
name|Address
name|iAddress
decl_stmt|;
specifier|private
name|RemoteQueueProcessor
name|iProcessor
decl_stmt|;
specifier|private
name|QueueProcessorInvocationHandler
parameter_list|(
name|Address
name|address
parameter_list|,
name|RemoteQueueProcessor
name|processor
parameter_list|)
block|{
name|iAddress
operator|=
name|address
expr_stmt|;
name|iProcessor
operator|=
name|processor
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|Object
name|invoke
parameter_list|(
name|Object
name|proxy
parameter_list|,
name|Method
name|method
parameter_list|,
name|Object
index|[]
name|args
parameter_list|)
throws|throws
name|Throwable
block|{
return|return
name|iProcessor
operator|.
name|dispatch
argument_list|(
name|iAddress
argument_list|,
name|method
argument_list|,
name|args
argument_list|)
return|;
block|}
block|}
block|}
end_class

end_unit

