begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * UniTime 3.2 (University Timetabling Application)  * Copyright (C) 2010, UniTime LLC, and individual contributors  * as indicated by the @authors tag.  *   * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License as published by  * the Free Software Foundation; either version 3 of the License, or  * (at your option) any later version.  *   * This program is distributed in the hope that it will be useful,  * but WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the  * GNU General Public License for more details.  *   * You should have received a copy of the GNU General Public License along  * with this program.  If not, see<http://www.gnu.org/licenses/>.  *  */
end_comment

begin_package
package|package
name|org
operator|.
name|unitime
operator|.
name|timetable
operator|.
name|solver
operator|.
name|curricula
operator|.
name|students
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|text
operator|.
name|DecimalFormat
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Comparator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Hashtable
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|TreeSet
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|dom4j
operator|.
name|Document
import|;
end_import

begin_import
import|import
name|org
operator|.
name|dom4j
operator|.
name|DocumentHelper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|dom4j
operator|.
name|Element
import|;
end_import

begin_import
import|import
name|org
operator|.
name|dom4j
operator|.
name|io
operator|.
name|OutputFormat
import|;
end_import

begin_import
import|import
name|org
operator|.
name|dom4j
operator|.
name|io
operator|.
name|SAXReader
import|;
end_import

begin_import
import|import
name|org
operator|.
name|dom4j
operator|.
name|io
operator|.
name|XMLWriter
import|;
end_import

begin_import
import|import
name|net
operator|.
name|sf
operator|.
name|cpsolver
operator|.
name|ifs
operator|.
name|model
operator|.
name|Model
import|;
end_import

begin_import
import|import
name|net
operator|.
name|sf
operator|.
name|cpsolver
operator|.
name|ifs
operator|.
name|model
operator|.
name|Neighbour
import|;
end_import

begin_import
import|import
name|net
operator|.
name|sf
operator|.
name|cpsolver
operator|.
name|ifs
operator|.
name|solution
operator|.
name|Solution
import|;
end_import

begin_import
import|import
name|net
operator|.
name|sf
operator|.
name|cpsolver
operator|.
name|ifs
operator|.
name|solution
operator|.
name|SolutionListener
import|;
end_import

begin_import
import|import
name|net
operator|.
name|sf
operator|.
name|cpsolver
operator|.
name|ifs
operator|.
name|solver
operator|.
name|Solver
import|;
end_import

begin_import
import|import
name|net
operator|.
name|sf
operator|.
name|cpsolver
operator|.
name|ifs
operator|.
name|util
operator|.
name|DataProperties
import|;
end_import

begin_import
import|import
name|net
operator|.
name|sf
operator|.
name|cpsolver
operator|.
name|ifs
operator|.
name|util
operator|.
name|ToolBox
import|;
end_import

begin_comment
comment|/**  * @author Tomas Muller  */
end_comment

begin_class
specifier|public
class|class
name|CurModel
extends|extends
name|Model
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
block|{
specifier|private
specifier|static
name|Log
name|sLog
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|CurModel
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|private
specifier|static
name|DecimalFormat
name|sDF
init|=
operator|new
name|DecimalFormat
argument_list|(
literal|"0.000"
argument_list|)
decl_stmt|;
specifier|private
name|List
argument_list|<
name|CurStudent
argument_list|>
name|iStudents
init|=
operator|new
name|ArrayList
argument_list|<
name|CurStudent
argument_list|>
argument_list|()
decl_stmt|;
specifier|private
name|Map
argument_list|<
name|Long
argument_list|,
name|CurCourse
argument_list|>
name|iCourses
init|=
operator|new
name|Hashtable
argument_list|<
name|Long
argument_list|,
name|CurCourse
argument_list|>
argument_list|()
decl_stmt|;
specifier|private
name|List
argument_list|<
name|CurCourse
argument_list|>
name|iSwapableCourses
init|=
operator|new
name|ArrayList
argument_list|<
name|CurCourse
argument_list|>
argument_list|()
decl_stmt|;
specifier|private
name|CurStudentLimit
name|iStudentLimit
init|=
literal|null
decl_stmt|;
specifier|private
name|double
name|iMinStudentWeight
init|=
name|Float
operator|.
name|MAX_VALUE
decl_stmt|,
name|iMaxStudentWeight
init|=
literal|0.0
decl_stmt|;
specifier|private
name|double
name|iAssignedWeight
init|=
literal|0.0
decl_stmt|,
name|iBestAssignedWeight
init|=
literal|0.0
decl_stmt|,
name|iMaxAssignedWeight
init|=
literal|0.0
decl_stmt|;
specifier|public
name|CurModel
parameter_list|(
name|Collection
argument_list|<
name|CurStudent
argument_list|>
name|students
parameter_list|)
block|{
name|iStudents
operator|.
name|addAll
argument_list|(
name|students
argument_list|)
expr_stmt|;
name|iStudentLimit
operator|=
operator|new
name|CurStudentLimit
argument_list|(
literal|0
argument_list|,
name|Integer
operator|.
name|MAX_VALUE
argument_list|)
expr_stmt|;
for|for
control|(
name|CurStudent
name|student
range|:
name|getStudents
argument_list|()
control|)
block|{
name|iMinStudentWeight
operator|=
name|Math
operator|.
name|min
argument_list|(
name|iMinStudentWeight
argument_list|,
name|student
operator|.
name|getWeight
argument_list|()
argument_list|)
expr_stmt|;
name|iMaxStudentWeight
operator|=
name|Math
operator|.
name|max
argument_list|(
name|iMaxStudentWeight
argument_list|,
name|student
operator|.
name|getWeight
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|double
name|getMinStudentWidth
parameter_list|()
block|{
return|return
name|iMinStudentWeight
return|;
block|}
specifier|public
name|double
name|getMaxStudentWidth
parameter_list|()
block|{
return|return
name|iMaxStudentWeight
return|;
block|}
specifier|public
name|void
name|addCourse
parameter_list|(
name|Long
name|courseId
parameter_list|,
name|String
name|courseName
parameter_list|,
name|double
name|size
parameter_list|)
block|{
name|CurCourse
name|course
init|=
operator|new
name|CurCourse
argument_list|(
name|this
argument_list|,
name|courseId
argument_list|,
name|courseName
argument_list|,
name|Math
operator|.
name|min
argument_list|(
name|iStudents
operator|.
name|size
argument_list|()
argument_list|,
operator|(
name|int
operator|)
name|Math
operator|.
name|round
argument_list|(
name|size
operator|/
name|getMinStudentWidth
argument_list|()
argument_list|)
argument_list|)
argument_list|,
name|size
argument_list|)
decl_stmt|;
name|iCourses
operator|.
name|put
argument_list|(
name|courseId
argument_list|,
name|course
argument_list|)
expr_stmt|;
if|if
condition|(
name|course
operator|.
name|getNrStudents
argument_list|()
operator|<
name|iStudents
operator|.
name|size
argument_list|()
condition|)
name|iSwapableCourses
operator|.
name|add
argument_list|(
name|course
argument_list|)
expr_stmt|;
name|iMaxAssignedWeight
operator|+=
name|course
operator|.
name|getOriginalMaxSize
argument_list|()
expr_stmt|;
block|}
specifier|public
name|void
name|setTargetShare
parameter_list|(
name|Long
name|c1
parameter_list|,
name|Long
name|c2
parameter_list|,
name|double
name|share
parameter_list|)
block|{
name|iCourses
operator|.
name|get
argument_list|(
name|c1
argument_list|)
operator|.
name|setTargetShare
argument_list|(
name|c2
argument_list|,
name|share
argument_list|)
expr_stmt|;
name|iCourses
operator|.
name|get
argument_list|(
name|c2
argument_list|)
operator|.
name|setTargetShare
argument_list|(
name|c1
argument_list|,
name|share
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|setStudentLimits
parameter_list|()
block|{
name|double
name|nrStudentCourses
init|=
literal|0
decl_stmt|;
for|for
control|(
name|CurCourse
name|course
range|:
name|getCourses
argument_list|()
control|)
block|{
name|nrStudentCourses
operator|+=
name|course
operator|.
name|getOriginalMaxSize
argument_list|()
expr_stmt|;
block|}
name|double
name|studentWeight
init|=
literal|0
decl_stmt|;
for|for
control|(
name|CurStudent
name|student
range|:
name|getStudents
argument_list|()
control|)
block|{
name|studentWeight
operator|+=
name|student
operator|.
name|getWeight
argument_list|()
expr_stmt|;
block|}
name|double
name|avg
init|=
name|nrStudentCourses
operator|/
name|studentWeight
decl_stmt|;
name|int
name|maxLimit
init|=
literal|1
operator|+
operator|(
name|int
operator|)
name|Math
operator|.
name|ceil
argument_list|(
name|avg
argument_list|)
decl_stmt|;
name|int
name|minLimit
init|=
operator|(
name|int
operator|)
name|Math
operator|.
name|floor
argument_list|(
name|avg
argument_list|)
operator|-
literal|1
decl_stmt|;
name|sLog
operator|.
name|debug
argument_list|(
literal|"Student course limit<"
operator|+
name|minLimit
operator|+
literal|","
operator|+
name|maxLimit
operator|+
literal|">"
argument_list|)
expr_stmt|;
name|iStudentLimit
operator|=
operator|new
name|CurStudentLimit
argument_list|(
name|minLimit
argument_list|,
name|maxLimit
argument_list|)
expr_stmt|;
name|addGlobalConstraint
argument_list|(
name|iStudentLimit
argument_list|)
expr_stmt|;
block|}
specifier|public
name|CurStudentLimit
name|getStudentLimit
parameter_list|()
block|{
return|return
name|iStudentLimit
return|;
block|}
specifier|public
name|Collection
argument_list|<
name|CurCourse
argument_list|>
name|getCourses
parameter_list|()
block|{
return|return
name|iCourses
operator|.
name|values
argument_list|()
return|;
block|}
specifier|public
name|CurCourse
name|getCourse
parameter_list|(
name|Long
name|courseId
parameter_list|)
block|{
return|return
name|iCourses
operator|.
name|get
argument_list|(
name|courseId
argument_list|)
return|;
block|}
specifier|public
name|List
argument_list|<
name|CurStudent
argument_list|>
name|getStudents
parameter_list|()
block|{
return|return
name|iStudents
return|;
block|}
specifier|public
name|List
argument_list|<
name|CurCourse
argument_list|>
name|getSwapCourses
parameter_list|()
block|{
return|return
name|iSwapableCourses
return|;
block|}
annotation|@
name|Override
specifier|public
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|getInfo
parameter_list|()
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|ret
init|=
name|super
operator|.
name|getInfo
argument_list|()
decl_stmt|;
name|ret
operator|.
name|put
argument_list|(
literal|"Students"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|getStudents
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|.
name|put
argument_list|(
literal|"Courses"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|getCourses
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|double
name|avgEnrollment
init|=
operator|(
operator|(
name|double
operator|)
name|variables
argument_list|()
operator|.
name|size
argument_list|()
operator|)
operator|/
name|getCourses
argument_list|()
operator|.
name|size
argument_list|()
decl_stmt|;
name|double
name|rmsEnrollment
init|=
literal|0.0
decl_stmt|;
for|for
control|(
name|CurCourse
name|c1
range|:
name|getCourses
argument_list|()
control|)
name|rmsEnrollment
operator|+=
operator|(
name|c1
operator|.
name|getNrStudents
argument_list|()
operator|-
name|avgEnrollment
operator|)
operator|*
operator|(
name|c1
operator|.
name|getNrStudents
argument_list|()
operator|-
name|avgEnrollment
operator|)
expr_stmt|;
name|ret
operator|.
name|put
argument_list|(
literal|"Course size"
argument_list|,
name|sDF
operator|.
name|format
argument_list|(
name|avgEnrollment
argument_list|)
operator|+
literal|" Â± "
operator|+
name|sDF
operator|.
name|format
argument_list|(
name|Math
operator|.
name|sqrt
argument_list|(
name|rmsEnrollment
operator|/
name|getCourses
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|int
name|totalCourses
init|=
literal|0
decl_stmt|;
for|for
control|(
name|CurStudent
name|student
range|:
name|getStudents
argument_list|()
control|)
name|totalCourses
operator|+=
name|student
operator|.
name|getCourses
argument_list|()
operator|.
name|size
argument_list|()
expr_stmt|;
name|double
name|avgCourses
init|=
operator|(
operator|(
name|double
operator|)
name|totalCourses
operator|)
operator|/
name|getStudents
argument_list|()
operator|.
name|size
argument_list|()
decl_stmt|;
name|double
name|rmsCourses
init|=
literal|0.0
decl_stmt|;
for|for
control|(
name|CurStudent
name|student
range|:
name|getStudents
argument_list|()
control|)
name|rmsCourses
operator|+=
operator|(
name|student
operator|.
name|getCourses
argument_list|()
operator|.
name|size
argument_list|()
operator|-
name|avgCourses
operator|)
operator|*
operator|(
name|student
operator|.
name|getCourses
argument_list|()
operator|.
name|size
argument_list|()
operator|-
name|avgCourses
operator|)
expr_stmt|;
name|ret
operator|.
name|put
argument_list|(
literal|"Courses per student"
argument_list|,
name|sDF
operator|.
name|format
argument_list|(
name|avgCourses
argument_list|)
operator|+
literal|" Â± "
operator|+
name|sDF
operator|.
name|format
argument_list|(
name|Math
operator|.
name|sqrt
argument_list|(
name|rmsCourses
operator|/
name|getStudents
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
operator|+
literal|" (limit: "
operator|+
name|getStudentLimit
argument_list|()
operator|.
name|getMinLimit
argument_list|()
operator|+
literal|" .. "
operator|+
name|getStudentLimit
argument_list|()
operator|.
name|getMaxLimit
argument_list|()
operator|+
literal|")"
argument_list|)
expr_stmt|;
name|int
name|totalShare
init|=
literal|0
decl_stmt|;
name|double
name|totalError
init|=
literal|0
decl_stmt|;
name|double
name|rmsError
init|=
literal|0.0
decl_stmt|;
name|int
name|pairs
init|=
literal|0
decl_stmt|;
for|for
control|(
name|CurCourse
name|c1
range|:
name|getCourses
argument_list|()
control|)
for|for
control|(
name|CurCourse
name|c2
range|:
name|getCourses
argument_list|()
control|)
if|if
condition|(
name|c1
operator|.
name|getCourseId
argument_list|()
operator|<
name|c2
operator|.
name|getCourseId
argument_list|()
condition|)
block|{
name|double
name|share
init|=
name|c1
operator|.
name|share
argument_list|(
name|c2
argument_list|)
decl_stmt|;
name|double
name|target
init|=
name|c1
operator|.
name|getTargetShare
argument_list|(
name|c2
operator|.
name|getCourseId
argument_list|()
argument_list|)
decl_stmt|;
name|totalError
operator|+=
name|Math
operator|.
name|abs
argument_list|(
name|share
operator|-
name|target
argument_list|)
expr_stmt|;
name|rmsError
operator|+=
operator|(
name|share
operator|-
name|target
operator|)
operator|*
operator|(
name|share
operator|-
name|target
operator|)
expr_stmt|;
name|pairs
operator|++
expr_stmt|;
name|totalShare
operator|+=
name|share
expr_stmt|;
block|}
name|ret
operator|.
name|put
argument_list|(
literal|"Errors"
argument_list|,
name|sDF
operator|.
name|format
argument_list|(
name|totalError
argument_list|)
operator|+
literal|" ("
operator|+
name|sDF
operator|.
name|format
argument_list|(
literal|100.0
operator|*
name|totalError
operator|/
name|totalShare
argument_list|)
operator|+
literal|"% of total share, avg: "
operator|+
name|sDF
operator|.
name|format
argument_list|(
operator|(
operator|(
name|double
operator|)
name|totalError
operator|)
operator|/
name|pairs
argument_list|)
operator|+
literal|", rms: "
operator|+
name|sDF
operator|.
name|format
argument_list|(
name|Math
operator|.
name|sqrt
argument_list|(
name|rmsError
operator|/
name|pairs
argument_list|)
argument_list|)
operator|+
literal|")"
argument_list|)
expr_stmt|;
name|ret
operator|.
name|put
argument_list|(
literal|"Assigned Student Weight"
argument_list|,
name|sDF
operator|.
name|format
argument_list|(
name|getAssignedWeight
argument_list|()
argument_list|)
operator|+
literal|"/"
operator|+
name|sDF
operator|.
name|format
argument_list|(
name|getMaxWeight
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|double
name|totalStudentWeight
init|=
literal|0
decl_stmt|;
for|for
control|(
name|CurStudent
name|student
range|:
name|getStudents
argument_list|()
control|)
block|{
name|totalStudentWeight
operator|+=
name|student
operator|.
name|getWeight
argument_list|()
expr_stmt|;
block|}
name|double
name|avgStudentWeight
init|=
name|totalStudentWeight
operator|/
name|getStudents
argument_list|()
operator|.
name|size
argument_list|()
decl_stmt|;
name|double
name|rmsStudentWeight
init|=
literal|0
decl_stmt|;
for|for
control|(
name|CurStudent
name|student
range|:
name|getStudents
argument_list|()
control|)
block|{
name|rmsStudentWeight
operator|+=
operator|(
name|student
operator|.
name|getWeight
argument_list|()
operator|-
name|avgStudentWeight
operator|)
operator|*
operator|(
name|student
operator|.
name|getWeight
argument_list|()
operator|-
name|avgStudentWeight
operator|)
expr_stmt|;
block|}
name|ret
operator|.
name|put
argument_list|(
literal|"Student Weight"
argument_list|,
name|sDF
operator|.
name|format
argument_list|(
name|getMinStudentWidth
argument_list|()
argument_list|)
operator|+
literal|" .. "
operator|+
name|sDF
operator|.
name|format
argument_list|(
name|getMaxStudentWidth
argument_list|()
argument_list|)
operator|+
literal|" (avg: "
operator|+
name|sDF
operator|.
name|format
argument_list|(
name|avgStudentWeight
argument_list|)
operator|+
literal|", rms: "
operator|+
name|sDF
operator|.
name|format
argument_list|(
name|Math
operator|.
name|sqrt
argument_list|(
name|rmsStudentWeight
operator|/
name|getStudents
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
argument_list|)
operator|+
literal|")"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
specifier|public
name|double
name|getTotalValue
parameter_list|()
block|{
name|double
name|value
init|=
literal|0
decl_stmt|;
for|for
control|(
name|CurCourse
name|c1
range|:
name|iCourses
operator|.
name|values
argument_list|()
control|)
for|for
control|(
name|CurCourse
name|c2
range|:
name|iCourses
operator|.
name|values
argument_list|()
control|)
if|if
condition|(
name|c1
operator|.
name|getCourseId
argument_list|()
operator|<
name|c2
operator|.
name|getCourseId
argument_list|()
condition|)
name|value
operator|+=
name|c1
operator|.
name|penalty
argument_list|(
name|c2
argument_list|)
expr_stmt|;
return|return
name|value
return|;
block|}
specifier|public
name|double
name|getAssignedWeight
parameter_list|()
block|{
return|return
name|iAssignedWeight
return|;
block|}
specifier|public
name|double
name|getMaxWeight
parameter_list|()
block|{
return|return
name|iMaxAssignedWeight
return|;
block|}
specifier|public
name|double
name|getBestWeight
parameter_list|()
block|{
return|return
name|iBestAssignedWeight
return|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|saveBest
parameter_list|()
block|{
name|super
operator|.
name|saveBest
argument_list|()
expr_stmt|;
name|iBestAssignedWeight
operator|=
name|iAssignedWeight
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|clearBest
parameter_list|()
block|{
name|super
operator|.
name|clearBest
argument_list|()
expr_stmt|;
name|iBestAssignedWeight
operator|=
literal|0.0
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|afterAssigned
parameter_list|(
name|long
name|iteration
parameter_list|,
name|CurValue
name|value
parameter_list|)
block|{
name|super
operator|.
name|afterAssigned
argument_list|(
name|iteration
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|iAssignedWeight
operator|+=
name|value
operator|.
name|getStudent
argument_list|()
operator|.
name|getWeight
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|afterUnassigned
parameter_list|(
name|long
name|iteration
parameter_list|,
name|CurValue
name|value
parameter_list|)
block|{
name|super
operator|.
name|afterUnassigned
argument_list|(
name|iteration
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|iAssignedWeight
operator|-=
name|value
operator|.
name|getStudent
argument_list|()
operator|.
name|getWeight
argument_list|()
expr_stmt|;
block|}
specifier|public
name|String
name|toString
parameter_list|()
block|{
return|return
name|assignedVariables
argument_list|()
operator|.
name|size
argument_list|()
operator|+
literal|"/"
operator|+
name|variables
argument_list|()
operator|.
name|size
argument_list|()
operator|+
literal|" V:"
operator|+
name|sDF
operator|.
name|format
argument_list|(
name|getTotalValue
argument_list|()
argument_list|)
operator|+
literal|" A:"
operator|+
name|sDF
operator|.
name|format
argument_list|(
name|getAssignedWeight
argument_list|()
argument_list|)
operator|+
literal|"/"
operator|+
name|sDF
operator|.
name|format
argument_list|(
name|getMaxWeight
argument_list|()
argument_list|)
return|;
block|}
specifier|public
name|void
name|ifs
parameter_list|()
block|{
name|net
operator|.
name|sf
operator|.
name|cpsolver
operator|.
name|ifs
operator|.
name|util
operator|.
name|DataProperties
name|cfg
init|=
operator|new
name|net
operator|.
name|sf
operator|.
name|cpsolver
operator|.
name|ifs
operator|.
name|util
operator|.
name|DataProperties
argument_list|()
decl_stmt|;
name|cfg
operator|.
name|setProperty
argument_list|(
literal|"Termination.Class"
argument_list|,
literal|"org.unitime.timetable.solver.curricula.students.CurTermination"
argument_list|)
expr_stmt|;
name|cfg
operator|.
name|setProperty
argument_list|(
literal|"Termination.StopWhenComplete"
argument_list|,
literal|"false"
argument_list|)
expr_stmt|;
name|cfg
operator|.
name|setProperty
argument_list|(
literal|"Termination.TimeOut"
argument_list|,
literal|"60"
argument_list|)
expr_stmt|;
name|cfg
operator|.
name|setProperty
argument_list|(
literal|"Termination.MaxIdle"
argument_list|,
literal|"1000"
argument_list|)
expr_stmt|;
name|cfg
operator|.
name|setProperty
argument_list|(
literal|"Comparator.Class"
argument_list|,
literal|"org.unitime.timetable.solver.curricula.students.CurComparator"
argument_list|)
expr_stmt|;
name|cfg
operator|.
name|setProperty
argument_list|(
literal|"Variable.Class"
argument_list|,
literal|"org.unitime.timetable.solver.curricula.students.CurVariableSelection"
argument_list|)
expr_stmt|;
name|cfg
operator|.
name|setProperty
argument_list|(
literal|"Value.Class"
argument_list|,
literal|"org.unitime.timetable.solver.curricula.students.CurValueSelection"
argument_list|)
expr_stmt|;
name|cfg
operator|.
name|setProperty
argument_list|(
literal|"General.SaveBestUnassigned"
argument_list|,
literal|"-1"
argument_list|)
expr_stmt|;
name|Solver
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|solver
init|=
operator|new
name|Solver
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
argument_list|(
name|cfg
argument_list|)
decl_stmt|;
name|solver
operator|.
name|setInitalSolution
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|solver
operator|.
name|currentSolution
argument_list|()
operator|.
name|addSolutionListener
argument_list|(
operator|new
name|SolutionListener
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|solutionUpdated
parameter_list|(
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|solution
parameter_list|)
block|{
block|}
annotation|@
name|Override
specifier|public
name|void
name|getInfo
parameter_list|(
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|solution
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|info
parameter_list|,
name|Collection
argument_list|<
name|CurVariable
argument_list|>
name|variables
parameter_list|)
block|{
block|}
annotation|@
name|Override
specifier|public
name|void
name|getInfo
parameter_list|(
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|solution
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|info
parameter_list|)
block|{
block|}
annotation|@
name|Override
specifier|public
name|void
name|bestSaved
parameter_list|(
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|solution
parameter_list|)
block|{
name|sLog
operator|.
name|debug
argument_list|(
name|solution
operator|.
name|getModel
argument_list|()
operator|.
name|toString
argument_list|()
operator|+
literal|", i:"
operator|+
name|solution
operator|.
name|getIteration
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|bestRestored
parameter_list|(
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|solution
parameter_list|)
block|{
block|}
annotation|@
name|Override
specifier|public
name|void
name|bestCleared
parameter_list|(
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|solution
parameter_list|)
block|{
block|}
block|}
argument_list|)
expr_stmt|;
name|solver
operator|.
name|start
argument_list|()
expr_stmt|;
try|try
block|{
name|solver
operator|.
name|getSolverThread
argument_list|()
operator|.
name|join
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
block|}
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|solution
init|=
name|solver
operator|.
name|lastSolution
argument_list|()
decl_stmt|;
name|solution
operator|.
name|restoreBest
argument_list|()
expr_stmt|;
name|sLog
operator|.
name|debug
argument_list|(
literal|"Best solution found after "
operator|+
name|solution
operator|.
name|getBestTime
argument_list|()
operator|+
literal|" seconds ("
operator|+
name|solution
operator|.
name|getBestIteration
argument_list|()
operator|+
literal|" iterations)."
argument_list|)
expr_stmt|;
name|sLog
operator|.
name|debug
argument_list|(
literal|"Number of assigned variables is "
operator|+
name|solution
operator|.
name|getModel
argument_list|()
operator|.
name|assignedVariables
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|sLog
operator|.
name|debug
argument_list|(
literal|"Total value of the solution is "
operator|+
name|solution
operator|.
name|getModel
argument_list|()
operator|.
name|getTotalValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|saveAsXml
parameter_list|(
name|Element
name|root
parameter_list|)
block|{
name|List
argument_list|<
name|Long
argument_list|>
name|courses
init|=
operator|new
name|ArrayList
argument_list|<
name|Long
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|CurCourse
name|course
range|:
name|getCourses
argument_list|()
control|)
block|{
name|Element
name|courseElement
init|=
name|root
operator|.
name|addElement
argument_list|(
literal|"course"
argument_list|)
decl_stmt|;
name|courseElement
operator|.
name|addAttribute
argument_list|(
literal|"id"
argument_list|,
name|course
operator|.
name|getCourseId
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|courseElement
operator|.
name|addAttribute
argument_list|(
literal|"name"
argument_list|,
name|course
operator|.
name|getCourseName
argument_list|()
argument_list|)
expr_stmt|;
name|courseElement
operator|.
name|addAttribute
argument_list|(
literal|"limit"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|course
operator|.
name|getOriginalMaxSize
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|courses
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|String
name|share
init|=
literal|""
decl_stmt|;
for|for
control|(
name|Long
name|other
range|:
name|courses
control|)
block|{
name|share
operator|+=
operator|(
name|share
operator|.
name|isEmpty
argument_list|()
condition|?
literal|""
else|:
literal|","
operator|)
operator|+
name|course
operator|.
name|getTargetShare
argument_list|(
name|other
argument_list|)
expr_stmt|;
block|}
name|courseElement
operator|.
name|addAttribute
argument_list|(
literal|"share"
argument_list|,
name|share
argument_list|)
expr_stmt|;
block|}
name|courses
operator|.
name|add
argument_list|(
name|course
operator|.
name|getCourseId
argument_list|()
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|CurStudent
name|student
range|:
name|getStudents
argument_list|()
control|)
block|{
name|Element
name|studentElement
init|=
name|root
operator|.
name|addElement
argument_list|(
literal|"student"
argument_list|)
decl_stmt|;
name|studentElement
operator|.
name|addAttribute
argument_list|(
literal|"id"
argument_list|,
name|student
operator|.
name|getStudentId
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|student
operator|.
name|getWeight
argument_list|()
operator|!=
literal|1.0
condition|)
name|studentElement
operator|.
name|addAttribute
argument_list|(
literal|"weight"
argument_list|,
name|String
operator|.
name|valueOf
argument_list|(
name|student
operator|.
name|getWeight
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|courseIds
init|=
literal|""
decl_stmt|;
for|for
control|(
name|CurCourse
name|course
range|:
name|student
operator|.
name|getCourses
argument_list|()
control|)
block|{
name|courseIds
operator|+=
operator|(
name|courseIds
operator|.
name|isEmpty
argument_list|()
condition|?
literal|""
else|:
literal|","
operator|)
operator|+
name|course
operator|.
name|getCourseId
argument_list|()
expr_stmt|;
block|}
name|studentElement
operator|.
name|setText
argument_list|(
name|courseIds
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
specifier|static
name|CurModel
name|loadFromXml
parameter_list|(
name|Element
name|root
parameter_list|)
block|{
name|List
argument_list|<
name|Element
argument_list|>
name|studentElements
init|=
name|root
operator|.
name|elements
argument_list|(
literal|"student"
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|CurStudent
argument_list|>
name|students
init|=
operator|new
name|ArrayList
argument_list|<
name|CurStudent
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|Element
name|studentElement
range|:
name|studentElements
control|)
block|{
name|students
operator|.
name|add
argument_list|(
operator|new
name|CurStudent
argument_list|(
name|Long
operator|.
name|valueOf
argument_list|(
name|studentElement
operator|.
name|attributeValue
argument_list|(
literal|"id"
argument_list|)
argument_list|)
argument_list|,
name|Float
operator|.
name|parseFloat
argument_list|(
name|studentElement
operator|.
name|attributeValue
argument_list|(
literal|"weight"
argument_list|,
literal|"1.0"
argument_list|)
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|CurModel
name|m
init|=
operator|new
name|CurModel
argument_list|(
name|students
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|Long
argument_list|>
name|courses
init|=
operator|new
name|ArrayList
argument_list|<
name|Long
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|Iterator
argument_list|<
name|Element
argument_list|>
name|i
init|=
name|root
operator|.
name|elementIterator
argument_list|(
literal|"course"
argument_list|)
init|;
name|i
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|Element
name|courseElement
init|=
name|i
operator|.
name|next
argument_list|()
decl_stmt|;
name|Long
name|courseId
init|=
name|Long
operator|.
name|valueOf
argument_list|(
name|courseElement
operator|.
name|attributeValue
argument_list|(
literal|"id"
argument_list|)
argument_list|)
decl_stmt|;
name|String
name|courseName
init|=
name|courseElement
operator|.
name|attributeValue
argument_list|(
literal|"name"
argument_list|)
decl_stmt|;
name|double
name|size
init|=
name|Float
operator|.
name|parseFloat
argument_list|(
name|courseElement
operator|.
name|attributeValue
argument_list|(
literal|"limit"
argument_list|)
argument_list|)
decl_stmt|;
name|m
operator|.
name|addCourse
argument_list|(
name|courseId
argument_list|,
name|courseName
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|courses
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|String
name|share
index|[]
init|=
name|courseElement
operator|.
name|attributeValue
argument_list|(
literal|"share"
argument_list|)
operator|.
name|split
argument_list|(
literal|","
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|j
init|=
literal|0
init|;
name|j
operator|<
name|courses
operator|.
name|size
argument_list|()
condition|;
name|j
operator|++
control|)
name|m
operator|.
name|setTargetShare
argument_list|(
name|courseId
argument_list|,
name|courses
operator|.
name|get
argument_list|(
name|j
argument_list|)
argument_list|,
name|Float
operator|.
name|parseFloat
argument_list|(
name|share
index|[
name|j
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|courses
operator|.
name|add
argument_list|(
name|courseId
argument_list|)
expr_stmt|;
block|}
name|int
name|idx
init|=
literal|0
decl_stmt|;
for|for
control|(
name|Element
name|studentElement
range|:
name|studentElements
control|)
block|{
name|CurStudent
name|student
init|=
name|students
operator|.
name|get
argument_list|(
name|idx
operator|++
argument_list|)
decl_stmt|;
name|String
name|courseIds
init|=
name|studentElement
operator|.
name|getText
argument_list|()
decl_stmt|;
if|if
condition|(
name|courseIds
operator|!=
literal|null
operator|&&
operator|!
name|courseIds
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
for|for
control|(
name|String
name|courseId
range|:
name|courseIds
operator|.
name|split
argument_list|(
literal|","
argument_list|)
control|)
block|{
name|CurCourse
name|course
init|=
name|m
operator|.
name|getCourse
argument_list|(
name|Long
operator|.
name|valueOf
argument_list|(
name|courseId
argument_list|)
argument_list|)
decl_stmt|;
name|CurVariable
name|var
init|=
literal|null
decl_stmt|;
for|for
control|(
name|CurVariable
name|v
range|:
name|course
operator|.
name|variables
argument_list|()
control|)
if|if
condition|(
name|v
operator|.
name|getAssignment
argument_list|()
operator|==
literal|null
condition|)
block|{
name|var
operator|=
name|v
expr_stmt|;
break|break;
block|}
name|var
operator|.
name|assign
argument_list|(
literal|0
argument_list|,
operator|new
name|CurValue
argument_list|(
name|var
argument_list|,
name|student
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|m
return|;
block|}
specifier|public
name|void
name|naive
parameter_list|(
name|DataProperties
name|cfg
parameter_list|)
block|{
name|sLog
operator|.
name|debug
argument_list|(
literal|"  -- running naive"
argument_list|)
expr_stmt|;
name|int
name|idle
init|=
literal|0
decl_stmt|,
name|it
init|=
literal|0
decl_stmt|;
name|double
name|best
init|=
name|getTotalValue
argument_list|()
decl_stmt|;
name|CurStudentSwap
name|sw
init|=
operator|new
name|CurStudentSwap
argument_list|(
name|cfg
argument_list|)
decl_stmt|;
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|solution
init|=
operator|new
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
argument_list|(
name|this
argument_list|)
decl_stmt|;
while|while
condition|(
operator|!
name|getSwapCourses
argument_list|()
operator|.
name|isEmpty
argument_list|()
operator|&&
name|idle
operator|<
literal|1000
condition|)
block|{
name|Neighbour
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|n
init|=
name|sw
operator|.
name|selectNeighbour
argument_list|(
name|solution
argument_list|)
decl_stmt|;
if|if
condition|(
name|n
operator|==
literal|null
condition|)
break|break;
name|double
name|value
init|=
name|n
operator|.
name|value
argument_list|()
decl_stmt|;
if|if
condition|(
name|value
operator|<
literal|0.0
condition|)
block|{
name|idle
operator|=
literal|0
expr_stmt|;
name|n
operator|.
name|assign
argument_list|(
name|it
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|value
operator|==
literal|0.0
condition|)
block|{
name|n
operator|.
name|assign
argument_list|(
name|it
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|getTotalValue
argument_list|()
operator|<
name|best
condition|)
block|{
name|best
operator|=
name|getTotalValue
argument_list|()
expr_stmt|;
name|sLog
operator|.
name|debug
argument_list|(
literal|"  -- best value: "
operator|+
name|this
argument_list|)
expr_stmt|;
block|}
name|it
operator|++
expr_stmt|;
name|idle
operator|++
expr_stmt|;
block|}
name|sLog
operator|.
name|debug
argument_list|(
literal|"  -- final value: "
operator|+
name|this
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|hc
parameter_list|(
name|DataProperties
name|cfg
parameter_list|)
block|{
name|sLog
operator|.
name|debug
argument_list|(
literal|"  -- running hill climber"
argument_list|)
expr_stmt|;
name|int
name|it
init|=
literal|0
decl_stmt|,
name|idle
init|=
literal|0
decl_stmt|;
name|double
name|total
init|=
name|getTotalValue
argument_list|()
decl_stmt|;
name|double
name|best
init|=
name|total
decl_stmt|;
name|CurHillClimber
name|hc
init|=
operator|new
name|CurHillClimber
argument_list|(
name|cfg
argument_list|)
decl_stmt|;
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|solution
init|=
operator|new
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
argument_list|(
name|this
argument_list|)
decl_stmt|;
while|while
condition|(
name|idle
operator|<
literal|1000
condition|)
block|{
name|Neighbour
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|n
init|=
name|hc
operator|.
name|selectNeighbour
argument_list|(
name|solution
argument_list|)
decl_stmt|;
if|if
condition|(
name|n
operator|==
literal|null
condition|)
break|break;
if|if
condition|(
name|unassignedVariables
argument_list|()
operator|.
name|isEmpty
argument_list|()
operator|&&
name|n
operator|.
name|value
argument_list|()
operator|>=
operator|-
literal|1e7f
condition|)
break|break;
name|total
operator|+=
name|n
operator|.
name|value
argument_list|()
expr_stmt|;
name|n
operator|.
name|assign
argument_list|(
name|it
argument_list|)
expr_stmt|;
if|if
condition|(
name|total
operator|<
name|best
condition|)
block|{
name|best
operator|=
name|total
expr_stmt|;
name|idle
operator|=
literal|0
expr_stmt|;
name|sLog
operator|.
name|debug
argument_list|(
literal|"  -- best value: "
operator|+
name|this
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|idle
operator|++
expr_stmt|;
block|}
name|it
operator|++
expr_stmt|;
block|}
name|sLog
operator|.
name|debug
argument_list|(
literal|"  -- final value: "
operator|+
name|this
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|deluge
parameter_list|(
name|DataProperties
name|cfg
parameter_list|)
block|{
name|sLog
operator|.
name|debug
argument_list|(
literal|"  -- running great deluge"
argument_list|)
expr_stmt|;
name|int
name|it
init|=
literal|0
decl_stmt|;
name|double
name|total
init|=
name|getTotalValue
argument_list|()
decl_stmt|;
name|double
name|bound
init|=
literal|1.25
operator|*
name|total
decl_stmt|;
name|double
name|best
init|=
name|getTotalValue
argument_list|()
decl_stmt|;
name|CurStudentSwap
name|sw
init|=
operator|new
name|CurStudentSwap
argument_list|(
name|cfg
argument_list|)
decl_stmt|;
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|solution
init|=
operator|new
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
argument_list|(
name|this
argument_list|)
decl_stmt|;
name|saveBest
argument_list|()
expr_stmt|;
while|while
condition|(
operator|!
name|getSwapCourses
argument_list|()
operator|.
name|isEmpty
argument_list|()
operator|&&
name|bound
operator|>
literal|0.75
operator|*
name|total
operator|&&
name|total
operator|>
literal|0
condition|)
block|{
name|Neighbour
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|n
init|=
name|sw
operator|.
name|selectNeighbour
argument_list|(
name|solution
argument_list|)
decl_stmt|;
if|if
condition|(
name|n
operator|!=
literal|null
condition|)
block|{
name|double
name|value
init|=
name|n
operator|.
name|value
argument_list|()
decl_stmt|;
if|if
condition|(
name|value
operator|<=
literal|0.0
operator|||
name|total
operator|+
name|value
operator|<
name|bound
condition|)
block|{
name|n
operator|.
name|assign
argument_list|(
name|it
argument_list|)
expr_stmt|;
if|if
condition|(
name|total
operator|+
name|value
operator|<
name|best
condition|)
block|{
name|best
operator|=
name|total
operator|+
name|value
expr_stmt|;
name|saveBest
argument_list|()
expr_stmt|;
name|sLog
operator|.
name|debug
argument_list|(
literal|"  -- best value: "
operator|+
name|this
operator|+
literal|", bound: "
operator|+
name|bound
argument_list|)
expr_stmt|;
block|}
name|total
operator|+=
name|value
expr_stmt|;
block|}
block|}
name|bound
operator|*=
literal|0.999999
expr_stmt|;
name|it
operator|++
expr_stmt|;
block|}
name|restoreBest
argument_list|()
expr_stmt|;
name|sLog
operator|.
name|debug
argument_list|(
literal|"  -- final value: "
operator|+
name|this
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|fast
parameter_list|(
name|DataProperties
name|cfg
parameter_list|)
block|{
name|sLog
operator|.
name|debug
argument_list|(
literal|"  -- running fast"
argument_list|)
expr_stmt|;
name|int
name|idle
init|=
literal|0
decl_stmt|,
name|it
init|=
literal|0
decl_stmt|;
name|double
name|total
init|=
name|getTotalValue
argument_list|()
decl_stmt|;
name|double
name|best
init|=
name|total
decl_stmt|;
name|CurSimpleMove
name|m
init|=
operator|new
name|CurSimpleMove
argument_list|(
name|cfg
argument_list|)
decl_stmt|;
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|solution
init|=
operator|new
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
argument_list|(
name|this
argument_list|)
decl_stmt|;
while|while
condition|(
name|idle
operator|<
literal|1000
condition|)
block|{
name|Neighbour
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|n
init|=
name|m
operator|.
name|selectNeighbour
argument_list|(
name|solution
argument_list|)
decl_stmt|;
if|if
condition|(
name|n
operator|!=
literal|null
condition|)
block|{
name|double
name|value
init|=
name|n
operator|.
name|value
argument_list|()
decl_stmt|;
if|if
condition|(
name|value
operator|<
literal|0.0
condition|)
block|{
name|idle
operator|=
literal|0
expr_stmt|;
name|n
operator|.
name|assign
argument_list|(
name|it
argument_list|)
expr_stmt|;
name|total
operator|+=
name|value
expr_stmt|;
block|}
if|else if
condition|(
name|value
operator|==
literal|0.0
condition|)
block|{
name|n
operator|.
name|assign
argument_list|(
name|it
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|total
operator|<
name|best
condition|)
block|{
name|best
operator|=
name|total
expr_stmt|;
name|sLog
operator|.
name|debug
argument_list|(
literal|"  -- best value: "
operator|+
name|this
argument_list|)
expr_stmt|;
block|}
name|it
operator|++
expr_stmt|;
name|idle
operator|++
expr_stmt|;
block|}
name|sLog
operator|.
name|debug
argument_list|(
literal|"  -- final value: "
operator|+
name|this
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|solve
parameter_list|()
block|{
name|sLog
operator|.
name|debug
argument_list|(
literal|"  -- setting up the solver"
argument_list|)
expr_stmt|;
name|DataProperties
name|cfg
init|=
operator|new
name|DataProperties
argument_list|()
decl_stmt|;
name|CurVariableSelection
name|var
init|=
operator|new
name|CurVariableSelection
argument_list|(
name|cfg
argument_list|)
decl_stmt|;
name|CurValueSelection
name|vs
init|=
operator|new
name|CurValueSelection
argument_list|(
name|cfg
argument_list|)
decl_stmt|;
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
name|solution
init|=
operator|new
name|Solution
argument_list|<
name|CurVariable
argument_list|,
name|CurValue
argument_list|>
argument_list|(
name|this
argument_list|)
decl_stmt|;
name|sLog
operator|.
name|debug
argument_list|(
literal|"  -- creating initial assignment"
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|unassignedVariables
argument_list|()
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|CurVariable
name|course
init|=
name|var
operator|.
name|selectVariable
argument_list|(
name|solution
argument_list|)
decl_stmt|;
if|if
condition|(
name|course
operator|.
name|getCourse
argument_list|()
operator|.
name|isComplete
argument_list|()
condition|)
block|{
name|sLog
operator|.
name|debug
argument_list|(
literal|"    -- all complete"
argument_list|)
expr_stmt|;
break|break;
block|}
name|CurValue
name|student
init|=
name|vs
operator|.
name|selectValueSlow
argument_list|(
name|solution
argument_list|,
name|course
argument_list|)
decl_stmt|;
if|if
condition|(
name|student
operator|==
literal|null
condition|)
block|{
name|sLog
operator|.
name|debug
argument_list|(
literal|"    -- no student for "
operator|+
name|course
operator|.
name|getCourse
argument_list|()
operator|.
name|getCourseName
argument_list|()
argument_list|)
expr_stmt|;
break|break;
block|}
name|student
operator|.
name|variable
argument_list|()
operator|.
name|assign
argument_list|(
name|solution
operator|.
name|getIteration
argument_list|()
argument_list|,
name|student
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|CurCourse
name|course
range|:
name|getCourses
argument_list|()
control|)
block|{
if|if
condition|(
operator|!
name|course
operator|.
name|isComplete
argument_list|()
condition|)
block|{
name|sLog
operator|.
name|debug
argument_list|(
literal|"    -- incomplete "
operator|+
name|course
operator|.
name|getCourseName
argument_list|()
operator|+
literal|": "
operator|+
name|getCourse
argument_list|(
name|course
operator|.
name|getCourseId
argument_list|()
argument_list|)
operator|.
name|getStudents
argument_list|()
operator|+
literal|" ("
operator|+
name|course
operator|.
name|getSize
argument_list|()
operator|+
literal|"/"
operator|+
name|course
operator|.
name|getOriginalMaxSize
argument_list|()
operator|+
literal|")"
argument_list|)
expr_stmt|;
block|}
block|}
name|sLog
operator|.
name|debug
argument_list|(
literal|"  -- initial value: "
operator|+
name|this
argument_list|)
expr_stmt|;
name|hc
argument_list|(
name|cfg
argument_list|)
expr_stmt|;
comment|// or fast(cfg);
name|deluge
argument_list|(
name|cfg
argument_list|)
expr_stmt|;
comment|// or naive(cfg);
block|}
specifier|public
name|boolean
name|isSameModel
parameter_list|(
name|Object
name|o
parameter_list|)
block|{
if|if
condition|(
name|o
operator|==
literal|null
operator|||
operator|!
operator|(
name|o
operator|instanceof
name|CurModel
operator|)
condition|)
return|return
literal|false
return|;
name|CurModel
name|m
init|=
operator|(
name|CurModel
operator|)
name|o
decl_stmt|;
if|if
condition|(
name|getStudents
argument_list|()
operator|.
name|size
argument_list|()
operator|!=
name|m
operator|.
name|getStudents
argument_list|()
operator|.
name|size
argument_list|()
condition|)
return|return
literal|false
return|;
if|if
condition|(
name|getStudentLimit
argument_list|()
operator|.
name|getMaxLimit
argument_list|()
operator|!=
name|m
operator|.
name|getStudentLimit
argument_list|()
operator|.
name|getMaxLimit
argument_list|()
condition|)
return|return
literal|false
return|;
if|if
condition|(
name|getStudentLimit
argument_list|()
operator|.
name|getMinLimit
argument_list|()
operator|!=
name|m
operator|.
name|getStudentLimit
argument_list|()
operator|.
name|getMinLimit
argument_list|()
condition|)
return|return
literal|false
return|;
if|if
condition|(
name|getMinStudentWidth
argument_list|()
operator|!=
name|m
operator|.
name|getMinStudentWidth
argument_list|()
condition|)
return|return
literal|false
return|;
if|if
condition|(
name|getCourses
argument_list|()
operator|.
name|size
argument_list|()
operator|!=
name|m
operator|.
name|getCourses
argument_list|()
operator|.
name|size
argument_list|()
condition|)
return|return
literal|false
return|;
name|students
label|:
for|for
control|(
name|CurStudent
name|s
range|:
name|getStudents
argument_list|()
control|)
block|{
if|if
condition|(
name|s
operator|.
name|getStudentId
argument_list|()
operator|==
literal|null
operator|||
name|s
operator|.
name|getStudentId
argument_list|()
operator|<
literal|0
condition|)
continue|continue;
for|for
control|(
name|CurStudent
name|z
range|:
name|m
operator|.
name|getStudents
argument_list|()
control|)
block|{
if|if
condition|(
name|z
operator|.
name|getStudentId
argument_list|()
operator|.
name|equals
argument_list|(
name|s
operator|.
name|getStudentId
argument_list|()
argument_list|)
operator|&&
name|z
operator|.
name|getWeight
argument_list|()
operator|==
name|s
operator|.
name|getWeight
argument_list|()
condition|)
continue|continue
name|students
continue|;
block|}
return|return
literal|false
return|;
block|}
name|students
label|:
for|for
control|(
name|CurStudent
name|s
range|:
name|m
operator|.
name|getStudents
argument_list|()
control|)
block|{
if|if
condition|(
name|s
operator|.
name|getStudentId
argument_list|()
operator|==
literal|null
operator|||
name|s
operator|.
name|getStudentId
argument_list|()
operator|<
literal|0
condition|)
continue|continue;
for|for
control|(
name|CurStudent
name|z
range|:
name|getStudents
argument_list|()
control|)
block|{
if|if
condition|(
name|z
operator|.
name|getStudentId
argument_list|()
operator|.
name|equals
argument_list|(
name|s
operator|.
name|getStudentId
argument_list|()
argument_list|)
operator|&&
name|z
operator|.
name|getWeight
argument_list|()
operator|==
name|s
operator|.
name|getWeight
argument_list|()
condition|)
continue|continue
name|students
continue|;
block|}
return|return
literal|false
return|;
block|}
for|for
control|(
name|int
name|idx
init|=
literal|0
init|;
name|idx
operator|<
name|getStudents
argument_list|()
operator|.
name|size
argument_list|()
condition|;
name|idx
operator|++
control|)
block|{
name|CurStudent
name|s
init|=
name|getStudents
argument_list|()
operator|.
name|get
argument_list|(
name|idx
argument_list|)
decl_stmt|;
if|if
condition|(
name|s
operator|.
name|getStudentId
argument_list|()
operator|!=
literal|null
operator|&&
name|s
operator|.
name|getStudentId
argument_list|()
operator|>=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|s
operator|.
name|getWeight
argument_list|()
operator|!=
name|m
operator|.
name|getStudents
argument_list|()
operator|.
name|get
argument_list|(
name|idx
argument_list|)
operator|.
name|getWeight
argument_list|()
condition|)
return|return
literal|false
return|;
block|}
for|for
control|(
name|CurCourse
name|c1
range|:
name|getCourses
argument_list|()
control|)
block|{
name|CurCourse
name|x1
init|=
name|m
operator|.
name|getCourse
argument_list|(
name|c1
operator|.
name|getCourseId
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|x1
operator|==
literal|null
operator|||
name|x1
operator|.
name|getNrStudents
argument_list|()
operator|!=
name|c1
operator|.
name|getNrStudents
argument_list|()
condition|)
return|return
literal|false
return|;
for|for
control|(
name|CurCourse
name|c2
range|:
name|getCourses
argument_list|()
control|)
if|if
condition|(
name|c1
operator|.
name|getCourseId
argument_list|()
operator|<
name|c2
operator|.
name|getCourseId
argument_list|()
operator|&&
name|Math
operator|.
name|abs
argument_list|(
name|c1
operator|.
name|getTargetShare
argument_list|(
name|c2
operator|.
name|getCourseId
argument_list|()
argument_list|)
operator|-
name|x1
operator|.
name|getTargetShare
argument_list|(
name|c2
operator|.
name|getCourseId
argument_list|()
argument_list|)
argument_list|)
operator|>
literal|0.001
condition|)
block|{
return|return
literal|false
return|;
block|}
block|}
return|return
literal|true
return|;
block|}
specifier|public
specifier|static
name|void
name|main
parameter_list|(
name|String
index|[]
name|args
parameter_list|)
block|{
try|try
block|{
name|List
argument_list|<
name|CurStudent
argument_list|>
name|students
init|=
operator|new
name|ArrayList
argument_list|<
name|CurStudent
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|20
condition|;
name|i
operator|++
control|)
name|students
operator|.
name|add
argument_list|(
operator|new
name|CurStudent
argument_list|(
operator|new
name|Long
argument_list|(
literal|1
operator|+
name|i
argument_list|)
argument_list|,
operator|(
name|i
operator|<
literal|10
condition|?
literal|0.5f
else|:
literal|2f
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|CurModel
name|m
init|=
operator|new
name|CurModel
argument_list|(
name|students
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|1
init|;
name|i
operator|<=
literal|10
condition|;
name|i
operator|++
control|)
name|m
operator|.
name|addCourse
argument_list|(
operator|(
name|long
operator|)
name|i
argument_list|,
literal|"C"
operator|+
name|i
argument_list|,
literal|2
operator|*
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|1
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
for|for
control|(
name|int
name|j
init|=
name|i
operator|+
literal|1
init|;
name|j
operator|<=
literal|10
condition|;
name|j
operator|++
control|)
name|m
operator|.
name|setTargetShare
argument_list|(
operator|(
name|long
operator|)
name|i
argument_list|,
operator|(
name|long
operator|)
name|j
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|m
operator|.
name|setStudentLimits
argument_list|()
expr_stmt|;
name|Document
name|d0
init|=
name|DocumentHelper
operator|.
name|createDocument
argument_list|()
decl_stmt|;
name|m
operator|.
name|saveAsXml
argument_list|(
name|d0
operator|.
name|addElement
argument_list|(
literal|"curriculum"
argument_list|)
argument_list|)
expr_stmt|;
name|sLog
operator|.
name|info
argument_list|(
name|d0
operator|.
name|asXML
argument_list|()
argument_list|)
expr_stmt|;
name|CurModel
name|n
init|=
name|CurModel
operator|.
name|loadFromXml
argument_list|(
operator|(
operator|new
name|SAXReader
argument_list|()
operator|)
operator|.
name|read
argument_list|(
literal|"/Users/muller/solution.xml"
argument_list|)
operator|.
name|getRootElement
argument_list|()
argument_list|)
decl_stmt|;
name|n
operator|.
name|setStudentLimits
argument_list|()
expr_stmt|;
name|sLog
operator|.
name|info
argument_list|(
literal|"Same model: "
operator|+
name|m
operator|.
name|isSameModel
argument_list|(
name|n
argument_list|)
operator|+
literal|", "
operator|+
name|n
operator|.
name|isSameModel
argument_list|(
name|m
argument_list|)
argument_list|)
expr_stmt|;
name|sLog
operator|.
name|info
argument_list|(
literal|"Loaded: "
operator|+
name|ToolBox
operator|.
name|dict2string
argument_list|(
name|m
operator|.
name|getInfo
argument_list|()
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|m
operator|.
name|solve
argument_list|()
expr_stmt|;
name|sLog
operator|.
name|info
argument_list|(
literal|"Solution: "
operator|+
name|ToolBox
operator|.
name|dict2string
argument_list|(
name|m
operator|.
name|getInfo
argument_list|()
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|Document
name|d1
init|=
name|DocumentHelper
operator|.
name|createDocument
argument_list|()
decl_stmt|;
name|m
operator|.
name|saveAsXml
argument_list|(
name|d1
operator|.
name|addElement
argument_list|(
literal|"curriculum"
argument_list|)
argument_list|)
expr_stmt|;
name|sLog
operator|.
name|info
argument_list|(
name|d1
operator|.
name|asXML
argument_list|()
argument_list|)
expr_stmt|;
name|TreeSet
argument_list|<
name|CurCourse
argument_list|>
name|courses
init|=
operator|new
name|TreeSet
argument_list|<
name|CurCourse
argument_list|>
argument_list|(
operator|new
name|Comparator
argument_list|<
name|CurCourse
argument_list|>
argument_list|()
block|{
specifier|public
name|int
name|compare
parameter_list|(
name|CurCourse
name|c1
parameter_list|,
name|CurCourse
name|c2
parameter_list|)
block|{
name|int
name|cmp
init|=
name|c1
operator|.
name|getCourseName
argument_list|()
operator|.
name|compareTo
argument_list|(
name|c2
operator|.
name|getCourseName
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmp
operator|!=
literal|0
condition|)
return|return
name|cmp
return|;
return|return
name|c1
operator|.
name|getCourseId
argument_list|()
operator|.
name|compareTo
argument_list|(
name|c2
operator|.
name|getCourseId
argument_list|()
argument_list|)
return|;
block|}
block|}
argument_list|)
decl_stmt|;
name|courses
operator|.
name|addAll
argument_list|(
name|m
operator|.
name|getCourses
argument_list|()
argument_list|)
expr_stmt|;
name|int
name|penalty
init|=
literal|0
decl_stmt|;
for|for
control|(
name|CurCourse
name|course
range|:
name|courses
control|)
block|{
name|sLog
operator|.
name|info
argument_list|(
name|course
operator|.
name|getCourseName
argument_list|()
operator|+
literal|": "
operator|+
name|m
operator|.
name|getCourse
argument_list|(
name|course
operator|.
name|getCourseId
argument_list|()
argument_list|)
operator|.
name|getStudents
argument_list|()
operator|+
literal|" ("
operator|+
name|course
operator|.
name|getSize
argument_list|()
operator|+
literal|"/"
operator|+
name|course
operator|.
name|getOriginalMaxSize
argument_list|()
operator|+
literal|")"
argument_list|)
expr_stmt|;
for|for
control|(
name|CurCourse
name|other
range|:
name|courses
control|)
block|{
if|if
condition|(
name|other
operator|.
name|getCourseId
argument_list|()
operator|<=
name|course
operator|.
name|getCourseId
argument_list|()
condition|)
continue|continue;
name|double
name|share
init|=
name|course
operator|.
name|share
argument_list|(
name|other
argument_list|)
decl_stmt|;
name|double
name|target
init|=
name|course
operator|.
name|getTargetShare
argument_list|(
name|other
operator|.
name|getCourseId
argument_list|()
argument_list|)
decl_stmt|;
name|sLog
operator|.
name|info
argument_list|(
literal|"  "
operator|+
name|other
operator|.
name|getCourseName
argument_list|()
operator|+
literal|": share="
operator|+
name|share
operator|+
literal|", target="
operator|+
name|target
operator|+
literal|", penalty="
operator|+
name|Math
operator|.
name|abs
argument_list|(
name|target
operator|-
name|share
argument_list|)
argument_list|)
expr_stmt|;
name|penalty
operator|+=
name|Math
operator|.
name|abs
argument_list|(
name|target
operator|-
name|share
argument_list|)
expr_stmt|;
block|}
block|}
name|sLog
operator|.
name|info
argument_list|(
literal|"Total penalty: "
operator|+
name|penalty
argument_list|)
expr_stmt|;
name|Document
name|doc
init|=
name|DocumentHelper
operator|.
name|createDocument
argument_list|()
decl_stmt|;
name|m
operator|.
name|saveAsXml
argument_list|(
name|doc
operator|.
name|addElement
argument_list|(
literal|"curriculum"
argument_list|)
argument_list|)
expr_stmt|;
name|FileOutputStream
name|fos
init|=
operator|new
name|FileOutputStream
argument_list|(
literal|"/Users/muller/solution.xml"
argument_list|)
decl_stmt|;
operator|(
operator|new
name|XMLWriter
argument_list|(
name|fos
argument_list|,
name|OutputFormat
operator|.
name|createPrettyPrint
argument_list|()
argument_list|)
operator|)
operator|.
name|write
argument_list|(
name|doc
argument_list|)
expr_stmt|;
name|fos
operator|.
name|flush
argument_list|()
expr_stmt|;
name|fos
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_class

end_unit

